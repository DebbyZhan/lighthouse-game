<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‰πæÂç¶„ÉªÁ†¥Êõâ‰πãÂÖâ | FINAL INTEGRATED</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* ====================
           CYBERPUNK CORE CSS
           ==================== */
        :root {
            --primary-color: #0f0;   /* Green */
            --secondary-color: #0ff; /* Cyan */
            --accent-color: #f0f;    /* Magenta */
            --warn-color: #ff3333;   /* Red */
            --bg-color: #020205;
            --mono-font: 'VT323', monospace;
            --tech-font: 'Orbitron', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); color: var(--primary-color);
            font-family: var(--mono-font); font-size: 18px;
            overflow: hidden; touch-action: none; user-select: none;
            overscroll-behavior: none;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* CRT Scanline Effects */
        body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 9990; pointer-events: none; background-size: 100% 2px, 3px 100%;
        }
        body::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: radial-gradient(circle, transparent 60%, rgba(0,0,0,0.8) 100%);
            z-index: 9991; pointer-events: none;
        }

        .hidden { display: none !important; }
        .glow-text { text-shadow: 0 0 5px var(--secondary-color), 0 0 15px var(--primary-color); }
        
        /* Cyberpunk Button */
        .cyber-btn {
            padding: 15px 30px; margin-top: 25px;
            font-family: var(--tech-font); font-size: 1.2rem; letter-spacing: 2px;
            color: var(--secondary-color); background: rgba(0, 20, 30, 0.8);
            border: 2px solid var(--secondary-color);
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            cursor: pointer; position: relative; overflow: hidden;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .cyber-btn:active { background: var(--secondary-color); color: #000; transform: scale(0.95); }
        .cyber-btn.glitch-mode {
            color: var(--warn-color); border-color: var(--warn-color);
            box-shadow: 0 0 15px var(--warn-color);
            animation: shake 0.5s infinite;
        }

        /* Content Layer - ‰øÆÊ≠£Â±Ö‰∏≠ÂïèÈ°å */
        #content-layer { width: 100%; height: 100%; transition: filter 0.5s ease; }
        .content-dimmed { filter: brightness(0.2) blur(3px) grayscale(50%); }
        
        .stage-box { 
            width: 100%; height: 100%; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; /* ÊîπÂõû Center */
            text-align: center; 
            padding-bottom: 20vh; /* È†êÁïôÂ∫ïÈÉ®Â∞çË©±Ê°ÜÁ©∫Èñì */
        }

        /* Loading Screen - ‰øÆÊ≠£Â±Ö‰∏≠ */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
        }

        /* STAGE 1: Scratch */
        .scratch-container {
            width: 85vw; height: 60vw; max-width: 500px; max-height: 350px;
            position: relative; margin: 20px auto;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            background: #000;
        }
        #scratch-progress {
            font-family: var(--tech-font); color: var(--secondary-color); 
            margin-top: 10px; font-size: 1.2rem;
        }

        /* STAGE 2: Roulette */
        .roulette-container {
            position: relative; width: 280px; height: 280px; margin: 30px auto;
            border-radius: 50%; border: 4px solid #333;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.1);
            overflow: hidden;
        }
        #color-wheel {
            width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(
                #FF0000 0deg 60deg,    /* Á¥Ö (1883) */
                #FFFFFF 60deg 120deg,  /* ÁôΩ (1918) */
                #00FF00 120deg 180deg, /* Á∂† */
                #0000FF 180deg 240deg, /* Ëóç */
                #111111 240deg 300deg, /* Èªë */
                #555555 300deg 360deg  /* ÈõúË®ä */
            );
            position: relative;
        }
        #color-wheel::after {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%; border-radius:50%;
            background: radial-gradient(circle, transparent 30%, #000 70%); 
        }
        .pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 25px solid var(--accent-color);
            filter: drop-shadow(0 0 5px var(--accent-color)); z-index: 10;
        }
        .target-display {
            font-family: var(--tech-font); font-size: 1.5rem; color: #FFF;
            margin-bottom: 10px; border: 1px solid var(--secondary-color);
            padding: 5px 20px; background: rgba(0,0,0,0.8);
        }

        /* STAGE 3: Radar */
        .radar-container {
            position: relative; width: 300px; height: 300px; margin: 30px auto;
            border-radius: 50%;
            background: 
                radial-gradient(transparent 30%, rgba(0, 255, 0, 0.2) 31%, transparent 32%),
                radial-gradient(transparent 60%, rgba(0, 255, 0, 0.2) 61%, transparent 62%),
                linear-gradient(0deg, transparent 49.5%, rgba(0, 255, 0, 0.5) 50%, transparent 50.5%),
                linear-gradient(90deg, transparent 49.5%, rgba(0, 255, 0, 0.5) 50%, transparent 50.5%);
            background-color: rgba(0, 20, 0, 0.3);
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2), inset 0 0 30px rgba(0, 255, 0, 0.2);
            overflow: hidden;
        }
        .radar-scan {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0, 255, 0, 0.5) 30deg, transparent 31deg);
            animation: radar-spin 2s linear infinite;
        }
        .compass-rose { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: transform 0.1s linear; }
        .north-mark {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            font-weight: bold; font-size: 1.2rem; color: var(--primary-color);
            text-shadow: 0 0 5px var(--primary-color);
        }
        .lock-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 280px; height: 280px; border-radius: 50%;
            border: 2px dashed rgba(255, 0, 0, 0.3); transition: all 0.3s;
        }
        .lock-active { border-color: var(--primary-color); border-width: 5px; box-shadow: 0 0 20px var(--primary-color); }

        /* Dialog System */
        #dialog-layer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9995;
            display: flex; flex-direction: column; justify-content: flex-end;
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        #dialog-box {
            position: relative; width: 94%; margin: 0 auto 20px auto;
            background: linear-gradient(180deg, rgba(0, 20, 30, 0.95) 0%, rgba(0, 10, 15, 0.98) 100%);
            border: 2px solid var(--secondary-color); border-bottom: 4px solid var(--primary-color);
            padding: 20px; pointer-events: auto; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        .speaker { 
            font-family: var(--tech-font); font-size: 0.9rem; 
            padding: 4px 10px; margin-bottom: 10px; display: inline-block;
            background: var(--secondary-color); color: #000; font-weight: bold;
            box-shadow: 0 0 10px var(--secondary-color);
        }
        .dialog-text { font-size: 1.2rem; color: #e0ffe0; min-height: 3.6rem; text-shadow: 0 0 2px rgba(0, 255, 0, 0.5); white-space: pre-wrap; line-height: 1.4; }
        .next-arrow { position: absolute; bottom: 10px; right: 15px; font-size: 1.5rem; color: var(--secondary-color); animation: bounce 1s infinite; }

        @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }
        @keyframes flashPlateau { 0% { opacity: 0; } 20% { opacity: 1; } 60% { opacity: 1; } 100% { opacity: 0; } }
        
        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; opacity: 0; pointer-events: none; z-index: 9999;
            mix-blend-mode: hard-light;
        }
        .flash-active { animation: flashPlateau 4s forwards; }

    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="glow-text" style="font-size: 1.5rem; animation: shake 2s infinite;">SYSTEM INITIALIZING</div>
        <div id="status-log" style="color: var(--secondary-color); margin-top:10px;">LOADING MODULES...</div>
        <button id="start-btn" class="cyber-btn hidden">INITIALIZE LINK</button>
    </div>

    <div id="flash-overlay"></div>

    <div id="content-layer">
        
        <div id="stage-1" class="stage-box hidden">
            <h2 class="glow-text">ÊôÇÁ©∫Èå®ÈªûÂª∫Á´ã</h2>
            <div id="gps-area">
                <div style="font-size: 4rem; margin: 20px; color: var(--secondary-color);">üõ∞Ô∏è</div>
                <div id="gps-msg" class="glow-text" style="color: var(--accent-color);">WAITING FOR SIGNAL...</div>
                <button id="gps-retry-btn" class="cyber-btn hidden">RE-SCAN</button>
            </div>
            
            <div id="scratch-area" class="hidden" style="opacity: 0; transition: opacity 1s;">
                <div class="scratch-container">
                    <img id="img-base" style="width:100%; height:100%; object-fit:cover; filter: sepia(1) hue-rotate(180deg) contrast(1.2);" />
                    <canvas id="cvs-cover" style="position:absolute; top:0; left:0; width:100%; height:100%; touch-action:none;"></canvas>
                </div>
                <p id="scratch-progress">SYNC: 0%</p>
            </div>
        </div>

        <div id="stage-2" class="stage-box hidden">
            <h2 class="glow-text">ÂÖâË≠úÈ†ªÁéáË™øÊ†°</h2>
            <div id="roulette-msg" class="target-display">TARGET: 1883 (RED)</div>
            
            <div class="roulette-container">
                <div class="pointer"></div>
                <div id="color-wheel"></div>
            </div>

            <button id="roulette-btn" class="cyber-btn">‚ö° LOCK FREQUENCY</button>
        </div>

        <div id="stage-3" class="stage-box hidden">
            <h2 class="glow-text">ÁµÇÁ´ØÈõ∑ÈÅîÈéñÂÆö</h2>
            <p style="color: var(--secondary-color);">TARGET: NORTH (ÂåóÊñπ)</p>
            
            <div class="radar-container">
                <div class="radar-scan"></div>
                <div class="lock-indicator" id="radar-lock-ring"></div>
                <div class="compass-rose" id="compass-ui">
                    <div class="north-mark">N</div>
                    <div style="position: absolute; bottom: 10px; left:50%; transform:translateX(-50%); color:rgba(0,255,0,0.5);">S</div>
                    <div style="position:absolute; top:50%; left:10%; width:80%; height:1px; background:rgba(0,255,0,0.3);"></div>
                    <div style="position:absolute; left:50%; top:10%; height:80%; width:1px; background:rgba(0,255,0,0.3);"></div>
                </div>
            </div>

            <button id="radar-btn" class="cyber-btn" disabled style="opacity: 0.5;">SEARCHING...</button>
        </div>

    </div>

    <div id="dialog-layer" class="hidden">
        <div id="dialog-box">
            <div id="speaker-name" class="speaker">SYSTEM</div>
            <div id="dialog-text-container" class="dialog-text"></div>
            <div id="next-arrow" class="next-arrow hidden">‚ñº</div>
        </div>
    </div>

    <script>
        // CONFIG
        const CONFIG = {
            liffId: "2008882930-UEAr0VU4", 
            devMode: true,
            targetGPS: { lat: 22.615556, lng: 120.265833 }, 
            gpsRadius: 1000000, 
            scratchThreshold: 90 // Áî®Êà∂Ë¶ÅÊ±Ç 90%
        };

        // ASSETS (Ë®òÂæóÂ°´ÂÖ•‰Ω†ÁöÑ Base64 ÊàñÂúñÁâá URL)
        const ASSETS = { 
            images: { 
                modern: null, // ÈÅÆÁΩ©Â±§ (Áèæ‰ª£)
                old: null     // Â∫ïÂ±§ (ËàäÊôÇ‰ª£)
            } 
        };
        
        function createImg(src) { if(!src) return null; const img = new Image(); img.crossOrigin = "Anonymous"; img.src = src; return img; }

        // SCRIPTS - ÊÅ¢Âæ©Á∂ìÂÖ∏ÁâàÂäáÊÉÖÔºå‰∏¶ËûçÂêàÊñ∞Áé©Ê≥ï
        const SCRIPTS = {
            intro: [
                { name: "ÈòøÊ∞¥ (Ë™ûÈü≥ÈõúË®ä)", text: "ÔºàÊªã...Êªã...Ôºâ‰∏çË°åÔºÅÂ∫ßÊ®ôÂ∞ç‰∏ç‰∏ä... ÊôÇÁ©∫‰∫ÇÊµÅÂ§™Âº∑‰∫ÜÔºÅ" },
                { name: "ÈòøÊ∞¥ (Ë™ûÈü≥ÈõúË®ä)", text: "Á≥ªÁµ±Ë™™ÈúÄË¶Å‰∏ÄÂÄã„ÄéÂº∑ÂäõÁöÑÁèæÂú∞Ë≠âÊòé„Äè... ‰Ω†ÁèæÂú®ÁúüÁöÑÂú®ÁáàÂ°îÈÇ£ÈÇäÂóéÔºü" },
                { name: "Á≥ªÁµ±AI", text: "ÂïüÂãïÁèæÂú∞Ë™çË≠âÂçîË≠∞„ÄÇÊ≠£Âú®ÊéÉÊèè GPS È†ªÊÆµ..." }
            ],
            gpsSuccess: [
                { name: "Á≥ªÁµ±AI", text: "‰ΩçÁΩÆÁ¢∫Ë™çÔºöÊóóÂæåÂ±±È†ÇÁØÄÈªû„ÄÇÂÅµÊ∏¨Âà∞È´òÂØÜÂ∫¶ÊôÇÁ©∫ÈÅÆËîΩÂäõÂ†¥„ÄÇ" },
                { name: "Á≥ªÁµ±AI", text: "Ê≠£Âú®ÊéõËºâÂΩ±ÂÉèËß£Á¢ºÊ®°ÁµÑ..." }
            ],
            scratchIntro: [
                { name: "ÈòøÊ∞¥", text: "ÈÄ£‰∏ä‰∫ÜÔºÅ...‰ΩÜÊàëÈÄôË£°ÁúãÂà∞ÁöÑÊôØË±°ÂÖÖÊªøÈõúË®ä... ÈÄôÁôΩËâ≤ÁöÑÁµêÊßãÈ´î... ‰∏çÊòØÊàëË®òÊÜ∂‰∏≠ÁöÑÊ®£Â≠êÔºÅ" },
                { name: "Á≤ΩÂì• (ÈÄöË®ä)", text: "ÂÖ©ÂÄãÊôÇÈñìÁ∑öÁöÑÊï∏ÊìöÊ≠£Âú®Ë°ùÁ™Å„ÄÇÊìç‰ΩúÂì°ÔºåÁî®‰Ω†ÁöÑÁîüÁâ©ÈõªÂ†¥ÔºàÊâãÊåáÔºâÂàÆÈñãÁèæ‰ª£ÁöÑÂÅΩË£ùÂúñÂ±§ÔºÅ" },
                { name: "Á≥ªÁµ±AI", text: "Ë´ãÈñãÂßãÂêåÊ≠•Ë¶ñË¶∫Êï∏Êìö„ÄÇ (ÈÅîÊàêÁéáÈúÄË∂ÖÈÅé 90%)" }
            ],
            stage1Clear: [
                { name: "ÈòøÊ∞¥", text: "ÈõúË®äÊ∏ÖÈô§‰∫ÜÔºÅÁ¥ÖËâ≤ÁöÑÁ£öÁâÜ... Ê≤íÈåØÔºåÈÄôÂ∞±ÊòØÊàëÈÄôÂÄãÂ∫ßÊ®ôÁöÑÁáàÂ°îÔºÅ" },
                { name: "ÈòøÊ∞¥", text: "Èå®ÈªûÂêåÊ≠•ÂÆåÊàêÔºÅÈ†ªÁéáÊé•ÈÄö‰∫ÜÔºÅ...‰ΩÜÊàë‰∏çÁü•ÈÅìË¶ÅÊâì‰ªÄÈ∫ºÈ°èËâ≤ÁöÑÂÖâÔºÅ" },
                { name: "Á≤ΩÂì•", text: "Âø´ÁúãËß£Ë™™ÁâåÔºÅ1883 Âπ¥Ë∑ü 1918 Âπ¥ÁöÑÁáàÂ°îÂàÜÂà•ÊòØÁî®‰ªÄÈ∫ºÈ°èËâ≤ÁöÑÊùêÊñôËìãÁöÑÔºüÊàëÂÄëÂ∞±ÊâìÈÇ£ÂÖ©ÂÄãÈ°èËâ≤ÁöÑÂÖâÔºÅ" },
                { name: "Á≥ªÁµ±AI", text: "ÂÖâË≠úËΩâÁõ§‰ªãÈù¢ÂïüÂãï„ÄÇÊ∫ñÂÇôËº∏ÂÖ•ÂèÉÊï∏ÔºöTarget 1883„ÄÇ" }
            ],
            glitchStart: [
                { name: "Á≥ªÁµ±Ë≠¶Â†±", text: "‚ö†Ô∏è Ë≠¶ÂëäÔºöÊôÇÁ©∫Â•áÁï∞ÈªûÊé•ËøëÔºÅË®äËôüÂ§±ÊéßÔºÅ" },
                { name: "ÈòøÊ∞¥", text: "Êäì‰∏ç‰ΩèË®äËôüÔºÅËΩâÁõ§ÁòãÊéâ‰∫ÜÔºÅÂø´Âπ´ÊàëÁ©©‰ΩèÂÆÉÔºÅÔºÅ" }
            ],
            round2Start: [
                { name: "Á≥ªÁµ±AI", text: "Ë®äËôüÂ∑≤Á©©ÂÆö„ÄÇÈÄ≤ÂÖ•Á¨¨‰∫åÈöéÊÆµÊ†°Ê∫ñ„ÄÇ" },
                { name: "ÈòøÊ∞¥", text: "Âëº... ÂöáÊ≠ªÊàë‰∫Ü„ÄÇ‰∏ã‰∏ÄÂÄãÊòØ 1918 Âπ¥ÔºÅÈÇ£ÊòØÊîπÂª∫ÊàêÁôΩËâ≤ÁöÑÊôÇÂÄôÔºÅ" }
            ],
            stage2Clear: [
                { name: "Á≥ªÁµ±AI", text: "ÂÖâË≠úÈéñÂÆöÂÆåÊàê„ÄÇSYNC COMPLETE„ÄÇ" },
                { name: "ÈòøÊ∞¥", text: "ÂÖâÊâìÂá∫Âéª‰∫ÜÔºÅ...ÊàëÁúãË¶ãÈòøÂºü‰∫ÜÔºÅ‰ªñÂæÄÂåóÈÇäÁöÑÊµ∑Èù¢Ë∑ë‰∫ÜÔºÅ" },
                { name: "ÈòøÊ∞¥", text: "Âø´ÊääÈõ∑ÈÅîÂ∞çÊ∫ñÂåóÊñπ (N)ÔºÅÊàëÂÄë‰∏çËÉΩË∑ü‰∏üÔºÅ" }
            ],
            final: [
                { name: "Á≥ªÁµ±AI", text: "ÁõÆÊ®ôÈéñÂÆö„ÄÇÂÇ≥ÈÄÅÂùêÊ®ôÊï∏Êìö..." },
                { name: "ÁµêÂ±Ä", text: "ÊÅ≠ÂñúÂÆåÊàê„ÄÇÈ´îÈ©óÁâàÁµêÊùü„ÄÇ(Ë´ãÈóúÊ≥®ÂæåÁ∫åÈóúÂç°)" }
            ]
        };

        // ELEMENTS
        const els = {
            loading: document.getElementById('loading-screen'),
            startBtn: document.getElementById('start-btn'),
            flash: document.getElementById('flash-overlay'),
            content: document.getElementById('content-layer'),
            dialogLayer: document.getElementById('dialog-layer'),
            dialogBox: document.getElementById('dialog-box'),
            speaker: document.getElementById('speaker-name'),
            text: document.getElementById('dialog-text-container'),
            arrow: document.getElementById('next-arrow'),
            
            // Stages
            stage1: document.getElementById('stage-1'),
            stage2: document.getElementById('stage-2'),
            stage3: document.getElementById('stage-3'),

            // Game Logic Refs
            wheel: document.getElementById('color-wheel'),
            rouletteBtn: document.getElementById('roulette-btn'),
            rouletteMsg: document.getElementById('roulette-msg'),
            compassUI: document.getElementById('compass-ui'),
            radarLock: document.getElementById('radar-lock-ring'),
            radarBtn: document.getElementById('radar-btn')
        };

        // CORE SYSTEM
        let scriptQueue = [];
        let onScriptEnd = null;
        let isTyping = false;
        let typingTimer = null;
        let currentFullText = "";

        async function init() {
            try {
                await liff.init({ liffId: CONFIG.liffId });
                // ÈÄôË£°ËºâÂÖ•ÂúñÁâá (Placeholder for now)
                // ASSETS.images.modern = createImg("YOUR_MODERN_IMG_URL");
                // ASSETS.images.old = createImg("YOUR_OLD_IMG_URL");
                
                if (!liff.isLoggedIn()) { liff.login(); return; }
                els.startBtn.classList.remove('hidden');
                document.getElementById('status-log').innerText = "SYSTEM READY";
            } catch (e) {
                if(CONFIG.devMode) els.startBtn.classList.remove('hidden');
            }
        }
        
        els.startBtn.onclick = () => {
            els.loading.classList.add('hidden');
            els.stage1.classList.remove('hidden');
            playScript(SCRIPTS.intro, checkGPS);
        };

        function playScript(script, callback) {
            scriptQueue = [...script];
            onScriptEnd = callback;
            els.dialogLayer.classList.remove('hidden');
            els.content.classList.add('content-dimmed');
            nextDialog();
        }

        function nextDialog() {
            if (scriptQueue.length === 0) {
                els.dialogLayer.classList.add('hidden');
                els.content.classList.remove('content-dimmed');
                if (onScriptEnd) onScriptEnd();
                return;
            }
            const line = scriptQueue.shift();
            els.speaker.innerText = line.name;
            currentFullText = line.text;
            
            if(line.name.includes("ÈòøÊ∞¥")) {
                els.speaker.style.backgroundColor = "var(--primary-color)"; 
                els.speaker.style.color = "#000";
            } else if(line.name.includes("Ë≠¶Â†±")) {
                els.speaker.style.backgroundColor = "var(--warn-color)";
                els.speaker.style.color = "#FFF";
            } else { // Á≥ªÁµ±
                els.speaker.style.backgroundColor = "var(--secondary-color)";
                els.speaker.style.color = "#000";
            }

            startTyping(currentFullText);
        }

        function startTyping(txt) {
            isTyping = true; els.text.innerHTML = ""; els.arrow.classList.add('hidden');
            let i = 0;
            clearInterval(typingTimer);
            typingTimer = setInterval(() => {
                els.text.innerText = txt.substring(0, i+1);
                i++;
                if(i >= txt.length) { clearInterval(typingTimer); isTyping = false; els.arrow.classList.remove('hidden'); }
            }, 30);
        }

        els.dialogBox.onclick = () => {
            if(isTyping) { clearInterval(typingTimer); els.text.innerText = currentFullText; isTyping = false; els.arrow.classList.remove('hidden'); }
            else { nextDialog(); }
        };

        // GPS Logic
        function checkGPS() {
            // Simplified success for demo
            const msg = document.getElementById('gps-msg');
            msg.innerText = "COORDINATES ACQUIRED";
            msg.style.color = "var(--primary-color)";
            setTimeout(() => {
                playScript(SCRIPTS.gpsSuccess, initScratch);
            }, 1000);
        }

        // Scratch Logic (Fixed Threshold & DPI)
        function initScratch() {
            document.getElementById('gps-area').classList.add('hidden');
            document.getElementById('scratch-area').classList.remove('hidden');
            setTimeout(() => document.getElementById('scratch-area').style.opacity = 1, 100);
            
            const canvas = document.getElementById('cvs-cover');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            const imgBase = document.getElementById('img-base');

            if (ASSETS.images.old) imgBase.src = ASSETS.images.old.src;

            // Retina display fix
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            // Draw initial mask
            const drawLayer = () => {
                ctx.globalCompositeOperation = 'source-over';
                if (ASSETS.images.modern && ASSETS.images.modern.complete) {
                    ctx.drawImage(ASSETS.images.modern, 0, 0, rect.width, rect.height);
                } else {
                    ctx.fillStyle = '#111'; ctx.fillRect(0, 0, rect.width, rect.height);
                    ctx.fillStyle = 'var(--secondary-color)'; ctx.font = "20px monospace"; 
                    ctx.fillText("MASK LAYER", 50, 100);
                }
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 60; // Á≠ÜÂà∑Âä†Â§ßÔºåËÆì90%Êõ¥ÂÆπÊòìÈÅîÊàê
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            };
            
            if (ASSETS.images.modern && !ASSETS.images.modern.complete) ASSETS.images.modern.onload = drawLayer;
            else drawLayer();

            let isDrawing = false;
            let finished = false;

            const getPos = (e) => {
                const touch = e.touches[0];
                const r = canvas.getBoundingClientRect();
                return { x: touch.clientX - r.left, y: touch.clientY - r.top };
            };

            canvas.addEventListener('touchstart', (e) => { 
                isDrawing = true; e.preventDefault();
                const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y);
            }, {passive:false});
            
            canvas.addEventListener('touchmove', (e) => {
                if(!isDrawing || finished) return; e.preventDefault();
                const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke();
                ctx.beginPath(); ctx.arc(p.x, p.y, 30, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.moveTo(p.x, p.y);
            }, {passive:false});

            canvas.addEventListener('touchend', () => {
                isDrawing = false;
                if(!finished) checkProgress();
            });

            function checkProgress() {
                const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
                let transparent = 0;
                // Sample every 40th pixel to improve perf
                for(let i=3; i<data.length; i+=160) {
                    if(data[i] < 128) transparent++;
                }
                const total = data.length / 160;
                const pct = Math.floor((transparent/total)*100);
                document.getElementById('scratch-progress').innerText = `SYNC: ${pct}%`;
                
                if(pct >= CONFIG.scratchThreshold) {
                    finished = true;
                    finishStage1();
                }
            }
            
            playScript(SCRIPTS.scratchIntro);
        }

        function finishStage1() {
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
            triggerFlashTransition('stage-1', 'stage-2');
            setTimeout(() => {
                playScript(SCRIPTS.stage1Clear, initRoulette);
            }, 2000);
        }

        function triggerFlashTransition(hideId, showId) {
            els.flash.classList.add('flash-active');
            setTimeout(() => {
                document.getElementById(hideId).classList.add('hidden');
                document.getElementById(showId).classList.remove('hidden');
            }, 1500);
            setTimeout(() => els.flash.classList.remove('flash-active'), 4000);
        }

        // Roulette Logic
        let rState = { angle: 0, speed: 2, running: false, mode: 'normal', targetColor: 'red', glitchCount: 0 };
        let animFrame;

        function initRoulette() {
            rState.mode = 'round1'; rState.targetColor = 'red'; rState.speed = 3; rState.running = true;
            els.rouletteMsg.innerText = "TARGET: 1883 (RED)";
            els.rouletteMsg.style.color = "#F00"; els.rouletteMsg.style.borderColor = "#F00";
            
            gameLoop();
            els.rouletteBtn.onclick = handleRouletteClick;
        }

        function gameLoop() {
            if (!rState.running) return;
            rState.angle = (rState.angle + rState.speed) % 360;
            if (rState.angle < 0) rState.angle += 360;
            els.wheel.style.transform = `rotate(${rState.angle}deg)`;
            animFrame = requestAnimationFrame(gameLoop);
        }

        function handleRouletteClick() {
            if (rState.mode === 'glitch') {
                rState.glitchCount++; rState.speed -= 3;
                if(navigator.vibrate) navigator.vibrate(50);
                if (rState.glitchCount >= 5) {
                    rState.running = false; cancelAnimationFrame(animFrame);
                    els.rouletteBtn.classList.remove('glitch-mode'); els.rouletteBtn.innerText = "‚ö° LOCK FREQUENCY";
                    setTimeout(() => playScript(SCRIPTS.round2Start, startRound2), 500);
                }
                return;
            }

            let effectiveAngle = (360 - rState.angle) % 360;
            let hit = false;
            // 0-60 is Red
            if (rState.targetColor === 'red' && effectiveAngle >= 0 && effectiveAngle < 60) hit = true;
            // 60-120 is White
            if (rState.targetColor === 'white' && effectiveAngle >= 60 && effectiveAngle < 120) hit = true;

            if (hit) {
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                rState.running = false; cancelAnimationFrame(animFrame);
                
                if (rState.mode === 'round1') {
                    els.rouletteMsg.innerText = "TARGET ACQUIRED";
                    setTimeout(() => playScript(SCRIPTS.glitchStart, () => {
                        rState.running = true; rState.mode = 'glitch'; rState.speed = 20; rState.glitchCount = 0;
                        els.rouletteBtn.innerText = "‚ö†Ô∏è STABILIZE ‚ö†Ô∏è"; els.rouletteBtn.classList.add('glitch-mode');
                        gameLoop();
                    }), 1000);
                } else if (rState.mode === 'round2') {
                    els.rouletteMsg.innerText = "SYNC COMPLETE"; els.rouletteMsg.style.color = "#0F0"; els.rouletteMsg.style.borderColor = "#0F0";
                    setTimeout(finishStage2, 1000);
                }
            } else {
                if (navigator.vibrate) navigator.vibrate(200);
                els.rouletteBtn.classList.add('glitch-mode'); setTimeout(() => els.rouletteBtn.classList.remove('glitch-mode'), 200);
            }
        }

        function startRound2() {
            rState.mode = 'round2'; rState.targetColor = 'white'; rState.speed = -4; rState.running = true;
            els.rouletteMsg.innerText = "TARGET: 1918 (WHITE)"; els.rouletteMsg.style.color = "#FFF"; els.rouletteMsg.style.borderColor = "#FFF";
            gameLoop();
        }

        function finishStage2() {
            triggerFlashTransition('stage-2', 'stage-3');
            setTimeout(() => playScript(SCRIPTS.stage2Clear, initRadar), 2000);
        }

        // Radar Logic
        function initRadar() {
            els.radarBtn.innerText = "ACTIVATE SENSORS";
            els.radarBtn.disabled = false; els.radarBtn.style.opacity = 1;
            els.radarBtn.onclick = () => {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission().then(r => { if (r === 'granted') startCompass(); }).catch(console.error);
                } else { startCompass(); }
            };
        }

        function startCompass() {
            els.radarBtn.innerText = "SEARCHING..."; els.radarBtn.disabled = true; els.radarBtn.style.opacity = 0.5;
            window.addEventListener('deviceorientation', handleOrientation);
        }

        function handleOrientation(e) {
            let heading = e.webkitCompassHeading || Math.abs(e.alpha - 360);
            els.compassUI.style.transform = `rotate(-${heading}deg)`;
            if (heading > 350 || heading < 10) {
                if(els.radarLock.classList.contains('lock-active')) return;
                els.radarLock.classList.add('lock-active');
                els.radarBtn.innerText = "üîí LOCKED: NORTH"; els.radarBtn.style.opacity = 1; 
                els.radarBtn.style.background = "var(--primary-color)"; els.radarBtn.style.color = "#000";
                if(navigator.vibrate) navigator.vibrate(200);
                setTimeout(() => { window.removeEventListener('deviceorientation', handleOrientation); playScript(SCRIPTS.final); }, 1000);
            } else {
                // optional: unlock if moved away
            }
        }

        window.onload = init;
    </script>
</body>
</html>
