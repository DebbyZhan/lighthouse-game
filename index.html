<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¹¾å¦ãƒ»ç ´æ›‰ä¹‹å…‰</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        /* ====================
           1. CSS æ¨£å¼ (V9 å½±é™¢ç‰ˆ - Polished)
           ==================== */
        :root {
            --primary-color: #00FF00;
            --bg-color: #000000;
            --alert-color: #FF3333;
            --text-font: 'Courier New', Courier, monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); color: var(--primary-color);
            font-family: var(--text-font); overflow: hidden; touch-action: none;
            user-select: none;
            /* é˜²æ­¢ iOS æ»¾å‹•å›å½ˆ */
            overscroll-behavior: none;
        }

        /* è¼‰å…¥å±¤ */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
        }
        .loading-text { font-size: 1.2rem; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .hidden { display: none !important; }

        #start-btn {
            margin-top: 20px; padding: 12px 30px; /* åŠ å¤§è§¸æ§å€ */
            border: 1px solid var(--primary-color); background: rgba(0, 255, 0, 0.1);
            color: var(--primary-color); font-size: 1rem; cursor: pointer;
            transition: all 0.2s;
        }
        #start-btn:active { background: var(--primary-color); color: #000; }

        /* V9 é‡é»ï¼šèƒŒæ™¯å…§å®¹å±¤ */
        #content-layer {
            width: 100%; height: 100%;
            transition: filter 0.5s ease;
            will-change: filter; /* æ•ˆèƒ½å„ªåŒ– */
        }
        
        .content-dimmed {
            filter: brightness(0.3) blur(2px);
        }

        .stage-box {
            width: 100%; height: 100%; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            text-align: center; padding-top: 20px;
        }

        .gps-status { font-size: 0.9rem; margin-top: 10px; color: var(--alert-color); min-height: 1.2em; }

        /* å°è©±æ¡†å±¤ */
        #dialog-layer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
            display: flex; flex-direction: column; justify-content: flex-end;
            padding-bottom: env(safe-area-inset-bottom, 30px); /* é©é… iPhone åº•éƒ¨æ©«æ¢ */
        }

        #dialog-box {
            position: relative; width: 90%; margin: 0 auto 20px auto;
            background: rgba(0, 15, 0, 0.95);
            border: 2px solid var(--primary-color);
            padding: 20px; text-align: left;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            cursor: pointer;
        }
        
        #dialog-box:active { transform: scale(0.98); }

        .speaker { 
            font-weight: bold; margin-bottom: 8px; color: #000; background: var(--primary-color); 
            display: inline-block; padding: 2px 8px; font-size: 0.9rem;
        }
        .dialog-text { 
            font-size: 1.1rem; line-height: 1.5; color: #FFF; min-height: 3.3rem; 
            white-space: pre-wrap; 
        }
        
        .cursor { display: inline-block; width: 10px; height: 1.2rem; background: var(--primary-color); animation: blink 0.8s infinite; vertical-align: middle; margin-left: 2px;}

        .next-arrow {
            position: absolute; bottom: 10px; right: 15px;
            color: var(--primary-color); font-size: 1.2rem;
            animation: bounce 1s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

        /* åˆ®åˆ®æ¨‚å®¹å™¨ */
        .scratch-container {
            position: relative;
            width: 90vw; height: 60vw;
            max-width: 600px; max-height: 400px;
            margin: 20px auto;
            border: 2px solid var(--primary-color);
            overflow: hidden;
            background-color: #000;
            transition: opacity 1s;
        }
        .scratch-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .scratch-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; touch-action: none; }

        /* é«˜åŸå¼ç™½å…‰æ›²ç·š */
        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; z-index: 9999;
        }
        .flash-active { animation: flashPlateau 4s forwards; }
        
        @keyframes flashPlateau {
            0% { opacity: 0; }
            20% { opacity: 1; }
            60% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-text">SYSTEM INITIALIZING...</div>
        <div class="loading-text" style="font-size: 0.8rem; margin-top: 10px;" id="status-log">Checking LIFF...</div>
        <button id="start-btn" class="hidden">TOUCH TO START</button>
    </div>

    <div id="flash-overlay"></div>

    <div id="content-layer">
        <div id="game-container" class="hidden">
            
            <div id="stage-1" class="stage-box">
                <h2 id="stage-title">é€£çµæ™‚ç©ºåº§æ¨™...</h2>
                
                <div id="gps-area">
                    <div id="gps-msg" class="gps-status">WAITING FOR SIGNAL...</div>
                    <button id="gps-retry-btn" class="hidden" style="border:1px solid red; background:none; color:red; padding:10px; margin-top:20px;">é‡æ–°æƒæè¨Šè™Ÿ</button>
                </div>

                <div id="scratch-area" class="hidden" style="opacity: 0;">
                    <div class="scratch-container">
                        <img id="img-base" class="scratch-bg" />
                        <canvas id="cvs-cover" class="scratch-canvas"></canvas>
                    </div>
                    <p id="scratch-progress">SYNC: 0%</p>
                </div>
            </div>

            <div id="stage-2" class="stage-box hidden">
                <h1 style="margin-top: 50%;">STAGE 2</h1>
                <p>é »ç‡æ ¡æº–ä¸­...</p>
            </div>

        </div>
    </div>

    <div id="dialog-layer" class="hidden">
        <div id="dialog-box">
            <div id="speaker-name" class="speaker">SYSTEM</div>
            <div id="dialog-text-container" class="dialog-text"></div>
            <div id="next-arrow" class="next-arrow hidden">â–¼</div>
        </div>
    </div>

    <script>
        /* ====================
           CONFIGURATION (è¨­å®šå€)
           ==================== */
        const CONFIG = {
            liffId: "2008882930-UEAr0VU4", // ä½ çš„ LIFF ID
            devMode: true,                 // æ¸¬è©¦æ¨¡å¼ (è·³é GPS æª¢æŸ¥)
            target: { lat: 22.615556, lng: 120.265833 }, // ç›®æ¨™ï¼šé«˜é›„ç‡ˆå¡” (Cijin)
            radius: 150,                   // å…è¨±èª¤å·® (å…¬å°º)
            scratchThreshold: 65           // åˆ®é–‹å¤šå°‘æ¯”ä¾‹ç®—éé—œ (%)
        };

        /* åŠ‡æœ¬åº«ï¼šé›†ä¸­ç®¡ç†å°è©ï¼Œæ–¹ä¾¿ä¿®æ”¹ */
        const SCRIPTS = {
            intro: [
                { name: "é˜¿æ°´ (èªéŸ³é›œè¨Š)", text: "ï¼ˆæ»‹...ï¼‰ä¸è¡Œï¼åº§æ¨™å°ä¸ä¸Š... æ™‚ç©ºäº‚æµå¤ªå¼·äº†ï¼" },
                { name: "é˜¿æ°´ (èªéŸ³é›œè¨Š)", text: "ç³»çµ±èªªéœ€è¦ä¸€å€‹ã€å¼·åŠ›çš„ç¾åœ°è­‰æ˜ã€... ä½ ç¾åœ¨çœŸçš„åœ¨ç‡ˆå¡”é‚£é‚Šå—ï¼Ÿ" },
                { name: "ç³»çµ±", text: "æ­£åœ¨å•Ÿå‹• GPS æƒææ¨¡çµ„..." }
            ],
            gpsSuccess: [
                { name: "ç³»çµ±", text: "ä½ç½®å·²ç¢ºèªã€‚åµæ¸¬åˆ°æ™‚ç©ºé®è”½åŠ›å ´ã€‚" },
                { name: "ç³»çµ±", text: "æ­£åœ¨è¼‰å…¥å½±åƒè§£ç¢¼å™¨..." }
            ],
            scratchIntro: [
                { name: "é˜¿æ°´", text: "é€£ä¸Šäº†ï¼...ä½†æˆ‘çœ‹åˆ°çš„æ™¯è±¡å¾ˆæ¨¡ç³Š... é€™ç™½è‰²çš„å¡”... ä¸æ˜¯æˆ‘é€™è£¡çš„æ¨£å­å•Šï¼Ÿ" },
                { name: "ç²½å“¥", text: "å…©å€‹æ™‚ä»£çš„å½±åƒæ­£åœ¨è¡çªã€‚å¹«å¹«ä»–ï¼Œç”¨æ‰‹æŒ‡æŠŠç¾ä»£çš„å½è£åˆ®é–‹ï¼" },
                { name: "ç³»çµ±", text: "è«‹é–‹å§‹åˆ®é–‹ç•«é¢ï¼ŒåŒæ­¥æ™‚ç©ºè¦–é‡ã€‚" }
            ],
            stage1Clear: [
                { name: "é˜¿æ°´", text: "çœ‹è¦‹äº†ï¼ç´…è‰²çš„ç£šç‰†... é€™å°±æ˜¯æˆ‘é€™è£¡çš„ç‡ˆå¡”ï¼" },
                { name: "é˜¿æ°´", text: "åæ¨™åŒæ­¥äº†ï¼è¬è¬ä½ ï¼" },
                { name: "ç³»çµ±", text: "Stage 1 å®Œæˆã€‚æ­£åœ¨åˆå§‹åŒ–å…‰è­œè½‰ç›¤..." }
            ]
        };

        /* ====================
           ASSETS (è³‡æºç®¡ç†)
           ==================== */
        // å»ºè­°å¡«å…¥å¯¦éš›çš„ Base64 æˆ– åœ–ç‰‡ URL
        // æç¤ºï¼šè‹¥ä½¿ç”¨ URLï¼Œè«‹ç¢ºä¿ Server æ”¯æ´ CORSï¼Œå¦å‰‡ Canvas æœƒå ±éŒ¯ (Tainted)
        const ASSETS = {
            images: {
                modern: null, // é®ç½©å±¤ (åˆ®æ‰çš„éƒ¨åˆ†ï¼Œç¾ä»£)
                old: null     // åº•å±¤ (é¡¯ç¤ºçš„éƒ¨åˆ†ï¼ŒèˆŠæ™‚ä»£)
            }
        };

        // ç°¡æ˜“åœ–ç‰‡è¼‰å…¥å™¨
        function loadImages() {
            // é€™è£¡æ”¾ä½ çš„ Base64 æˆ–æ˜¯åœ–ç‰‡é€£çµ
            // ç‚ºäº†ç¤ºç¯„ï¼Œæˆ‘ç”¢ç”Ÿå…©å€‹ç°¡å–®çš„ Placeholder
            return new Promise(resolve => {
                // æ¨¡æ“¬è¼‰å…¥... (å¯¦éš›å°ˆæ¡ˆè«‹å¡«å…¥ä½ çš„ Base64 å­—ä¸²)
                // ASSETS.images.modern = createImg("...");
                // ASSETS.images.old = createImg("...");
                resolve();
            });
        }
        
        function createImg(src) {
            if(!src) return null;
            const img = new Image();
            img.crossOrigin = "Anonymous"; // é˜²æ­¢ CORS æ±¡æŸ“
            img.src = src;
            return img;
        }

        /* ====================
           SYSTEM CORE
           ==================== */
        const els = {
            log: document.getElementById('status-log'),
            startBtn: document.getElementById('start-btn'),
            content: document.getElementById('content-layer'),
            dialogLayer: document.getElementById('dialog-layer'),
            dialogBox: document.getElementById('dialog-box'),
            speaker: document.getElementById('speaker-name'),
            text: document.getElementById('dialog-text-container'),
            arrow: document.getElementById('next-arrow'),
            game: document.getElementById('game-container'),
            loading: document.getElementById('loading-screen'),
            flash: document.getElementById('flash-overlay')
        };

        function log(msg) { els.log.innerText = msg; console.log(`[Sys] ${msg}`); }

        // --- æ‰“å­—æ©Ÿç³»çµ± ---
        let scriptQueue = [];
        let onScriptComplete = null;
        let typingTimer = null;
        let currentFullText = "";
        let isTyping = false;

        function playScript(script, callback) {
            scriptQueue = [...script]; // è¤‡è£½ä¸€ä»½ä»¥å…å½±éŸ¿åŸé™£åˆ—
            onScriptComplete = callback;
            els.dialogLayer.classList.remove('hidden');
            els.content.classList.add('content-dimmed');
            nextDialog();
        }

        function nextDialog() {
            if (scriptQueue.length === 0) {
                els.dialogLayer.classList.add('hidden');
                els.content.classList.remove('content-dimmed');
                if (onScriptComplete) onScriptComplete();
                return;
            }

            const line = scriptQueue.shift();
            els.speaker.innerText = line.name;
            currentFullText = line.text;

            // æ ¹æ“šè§’è‰²æ›è‰² (å¯ä»¥æ“´å……)
            if (line.name.includes("é˜¿æ°´")) els.speaker.style.backgroundColor = "#00AA00";
            else if (line.name === "ç²½å“¥") els.speaker.style.backgroundColor = "#888888"; 
            else els.speaker.style.backgroundColor = "var(--primary-color)";

            startTyping(currentFullText);
        }

        function startTyping(text) {
            isTyping = true;
            els.text.innerHTML = "";
            els.arrow.classList.add('hidden');
            let i = 0;
            const cursor = '<span class="cursor"></span>';
            
            clearInterval(typingTimer);
            typingTimer = setInterval(() => {
                els.text.innerHTML = text.substring(0, i+1) + cursor;
                i++;
                if (i >= text.length) finishTyping();
            }, 40); // ç¨å¾®åŠ å¿«æ‰“å­—é€Ÿåº¦
        }

        function finishTyping() {
            clearInterval(typingTimer);
            isTyping = false;
            els.text.innerText = currentFullText;
            els.arrow.classList.remove('hidden');
        }

        els.dialogBox.addEventListener('click', () => {
            if (isTyping) finishTyping();
            else {
                if (navigator.vibrate) navigator.vibrate(10);
                nextDialog();
            }
        });

        // --- åˆå§‹åŒ–æµç¨‹ ---
        async function initSystem() {
            try {
                log("Init LIFF...");
                await liff.init({ liffId: CONFIG.liffId });
                // è¼‰å…¥åœ–ç‰‡è³‡æº
                await loadImages();
                
                log("Ready.");
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                els.startBtn.classList.remove('hidden');
            } catch (err) { 
                log("Error: " + err.message); 
                // å³ä½¿ LIFF å¤±æ•—ä¹Ÿå…è¨±åœ¨ Dev æ¨¡å¼ä¸‹é‹è¡Œ
                if(CONFIG.devMode) els.startBtn.classList.remove('hidden');
            }
        }

        els.startBtn.addEventListener('click', () => {
            els.loading.classList.add('hidden');
            els.game.classList.remove('hidden');
            playScript(SCRIPTS.intro, checkGPS);
        });

        // --- GPS é‚è¼¯ ---
        function checkGPS() {
            const msgBox = document.getElementById('gps-msg');
            const retryBtn = document.getElementById('gps-retry-btn');
            
            msgBox.innerText = "æƒæä¸­...";
            retryBtn.classList.add('hidden');

            if (!navigator.geolocation) { msgBox.innerText = "è£ç½®ä¸æ”¯æ´ GPS"; return; }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const dist = getDistanceFromLatLonInKm(lat, lng, CONFIG.target.lat, CONFIG.target.lng) * 1000;

                    if (CONFIG.devMode || dist < CONFIG.radius) {
                        msgBox.innerText = `ğŸ“ ä½ç½®ç¢ºèªï¼šæ——å¾Œå±± (${dist.toFixed(0)}m)`;
                        msgBox.style.color = "var(--primary-color)";
                        setTimeout(() => playScript(SCRIPTS.gpsSuccess, initScratchGame), 1000);
                    } else {
                        msgBox.innerText = `âš ï¸ è·é›¢ç›®æ¨™é‚„æœ‰ ${(dist).toFixed(0)}m`;
                        msgBox.style.color = "var(--alert-color)";
                        retryBtn.classList.remove('hidden');
                        retryBtn.onclick = checkGPS;
                    }
                },
                (err) => {
                    msgBox.innerText = "ç„¡æ³•å–å¾—ä½ç½® (è«‹é–‹å•Ÿ GPS)";
                    retryBtn.classList.remove('hidden');
                    retryBtn.onclick = checkGPS;
                }, { enableHighAccuracy: true, timeout: 5000 }
            );
        }

        // --- åˆ®åˆ®æ¨‚é‚è¼¯ (Stage 1) ---
        function initScratchGame() {
            const scratchArea = document.getElementById('scratch-area');
            scratchArea.classList.remove('hidden');
            setTimeout(() => scratchArea.style.opacity = 1, 100);
            
            document.getElementById('gps-area').classList.add('hidden');
            document.getElementById('stage-title').innerText = "åŒæ­¥æ™‚ç©ºè¦–é‡";

            playScript(SCRIPTS.scratchIntro, setupCanvas);
        }

        function setupCanvas() {
            const canvas = document.getElementById('cvs-cover');
            const ctx = canvas.getContext('2d');
            const imgBase = document.getElementById('img-base');
            const container = canvas.parentElement;

            // è¨­å®šèˆŠåœ– (å¦‚æœæœ‰è³‡æº)
            if (ASSETS.images.old) imgBase.src = ASSETS.images.old.src;

            // --- é‡é»å„ªåŒ–ï¼šè™•ç† Retina è¢å¹•æ¨¡ç³Šå•é¡Œ ---
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            // ç¸®æ”¾ Context ä»¥åŒ¹é… CSS å°ºå¯¸
            ctx.scale(dpr, dpr); 

            const drawLayer = () => {
                ctx.globalCompositeOperation = 'source-over';
                if (ASSETS.images.modern && ASSETS.images.modern.complete) {
                    // ä½¿ç”¨ rect.width/height ç¹ªè£½åˆ°é‚è¼¯å°ºå¯¸
                    ctx.drawImage(ASSETS.images.modern, 0, 0, rect.width, rect.height);
                } else {
                    // é è¨­é®ç½©é¡è‰²
                    ctx.fillStyle = '#CCCCCC'; 
                    ctx.fillRect(0, 0, rect.width, rect.height);
                    ctx.fillStyle = '#000';
                    ctx.font = "20px Courier";
                    ctx.fillText("NO SIGNAL IMAGE", 50, 50);
                }
                // è¨­å®šç­†åˆ·æ¨¡å¼
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 40; 
                ctx.lineCap = 'round'; 
                ctx.lineJoin = 'round';
            };

            // ç¢ºä¿åœ–ç‰‡è¼‰å…¥å¾Œç¹ªè£½
            if (ASSETS.images.modern && !ASSETS.images.modern.complete) {
                ASSETS.images.modern.onload = drawLayer;
            } else { drawLayer(); }

            // è§¸æ§äº‹ä»¶
            let isDrawing = false;
            
            // å–å¾—æ­£ç¢ºçš„è§¸æ§åº§æ¨™ (ä¿®æ­£ dpr èˆ‡ offset)
            const getPos = (e) => {
                const touch = e.touches[0];
                const r = canvas.getBoundingClientRect();
                return {
                    x: touch.clientX - r.left,
                    y: touch.clientY - r.top
                };
            };

            canvas.addEventListener('touchstart', (e) => { 
                isDrawing = true; 
                e.preventDefault(); // é˜²æ­¢æ»¾å‹•
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                if (!isDrawing) return;
                e.preventDefault(); // å¼·åˆ¶é˜²æ­¢æ»¾å‹•
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                
                // å¢åŠ åœ“é»è®“å¿«é€Ÿç§»å‹•æ™‚ç·šæ¢æ›´åœ“æ»‘
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 20, 0, Math.PI*2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }, { passive: false });

            canvas.addEventListener('touchend', () => {
                isDrawing = false;
                checkProgress(ctx, canvas.width, canvas.height); // check logic uses real pixels
            });
        }

        let stage1Finished = false;
        function checkProgress(ctx, w, h) {
            if (stage1Finished) return; 

            // æ³¨æ„ï¼šgetImageData å–çš„æ˜¯ç‰©ç†åƒç´  (Device Pixels)
            // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘åªæŠ½æ¨£æª¢æŸ¥ï¼Œä¸ç”¨æŸ¥æ¯ä¸€å€‹ pixel
            const data = ctx.getImageData(0, 0, w, h).data;
            let transparent = 0;
            const sampleRate = 32; // æé«˜æŠ½æ¨£é–“éš”ä»¥å¢åŠ æ•ˆèƒ½
            
            for(let i = 3; i < data.length; i += 4 * sampleRate) { 
                if(data[i] < 128) transparent++; 
            }
            
            const totalSamples = data.length / (4 * sampleRate);
            const percent = Math.floor((transparent / totalSamples) * 100);
            
            document.getElementById('scratch-progress').innerText = `SYNC: ${percent}%`;
            
            if (percent > CONFIG.scratchThreshold) {
                stage1Finished = true;
                finishStage1();
            }
        }

        function finishStage1() {
            // è§¸ç™¼éœ‡å‹•
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            
            setTimeout(() => {
                els.flash.classList.add('flash-active');
                
                // å‹•ç•«ä¸­æ®µæ›æ™¯
                setTimeout(() => {
                    document.getElementById('stage-1').classList.add('hidden');
                    document.getElementById('stage-2').classList.remove('hidden');
                    
                    setTimeout(() => {
                        playScript(SCRIPTS.stage1Clear, () => {
                            console.log("Enter Stage 2 Logic");
                        });
                    }, 2000); 
                }, 1500); 

            }, 1000); 
        }

        // --- Utils ---
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
            var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            var c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R*c;
        }
        function deg2rad(deg) { return deg*(Math.PI/180); }

        window.onload = initSystem;
    </script>
</body>
</html>
