<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¹¾å¦ãƒ»ç ´æ›‰ä¹‹å…‰ | RADAR FIX</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* ====================
           CYBERPUNK VISUAL CORE
           ==================== */
        :root {
            --primary-color: #0f0;   
            --secondary-color: #0ff; 
            --accent-color: #f0f;    
            --warn-color: #ff2a2a;   /* æ›´é®®è±”çš„ç´… */
            --bg-color: #050508;
            --mono-font: 'VT323', monospace;
            --tech-font: 'Orbitron', sans-serif;
            --tension-level: 0; /* 0 to 1, JSæ§åˆ¶ */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); color: var(--primary-color);
            font-family: var(--mono-font); font-size: 18px;
            overflow: hidden; touch-action: none; user-select: none;
            overscroll-behavior: none;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* CRT Effects */
        body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 9990; pointer-events: none; background-size: 100% 2px, 3px 100%;
        }
        
        .hidden { display: none !important; }
        .glow-text { text-shadow: 0 0 5px var(--secondary-color), 0 0 15px var(--primary-color); }
        
        /* Cyberpunk Button */
        .cyber-btn {
            padding: 15px 30px; margin-top: 25px;
            font-family: var(--tech-font); font-size: 1.2rem; letter-spacing: 2px;
            color: var(--secondary-color); background: rgba(0, 20, 30, 0.9);
            border: 2px solid var(--secondary-color);
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            cursor: pointer; position: relative; overflow: hidden;
            transition: all 0.1s; text-transform: uppercase;
        }
        .cyber-btn:active { background: var(--secondary-color); color: #000; transform: scale(0.98); }
        .cyber-btn.glitch-mode {
            color: #FFF; background: var(--warn-color); border-color: #FFF;
            box-shadow: 0 0 20px var(--warn-color); animation: shake 0.2s infinite;
        }
        .cyber-btn.locking-mode {
            color: #000; background: #ffff00; border-color: #ffff00;
            box-shadow: 0 0 20px #ffff00;
        }

        /* Layout */
        #content-layer { width: 100%; height: 100%; transition: filter 0.5s ease; will-change: filter, opacity; }
        .content-dimmed { filter: brightness(0.2) blur(3px) grayscale(50%); }
        .stage-box { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center; 
            padding-bottom: 20vh;
        }

        /* STAGE 1: Scratch */
        .scratch-container {
            width: 85vw; height: 60vw; max-width: 500px; max-height: 350px;
            position: relative; margin: 20px auto;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            background: #000;
        }
        #scratch-progress { font-family: var(--tech-font); color: var(--secondary-color); margin-top: 10px; }

        /* STAGE 2: Roulette */
        .roulette-container {
            position: relative; width: 280px; height: 280px; margin: 30px auto;
            border-radius: 50%; border: 4px solid #333;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.1); overflow: hidden;
        }
        #color-wheel {
            width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(#FF0000 0deg 60deg, #FFFFFF 60deg 120deg, #00FF00 120deg 180deg, #0000FF 180deg 240deg, #111111 240deg 300deg, #555555 300deg 360deg);
        }
        .pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--accent-color);
            filter: drop-shadow(0 0 5px var(--accent-color)); z-index: 10;
        }
        .target-display {
            font-family: var(--tech-font); font-size: 1.5rem; color: #FFF;
            margin-bottom: 10px; border: 1px solid var(--secondary-color); padding: 5px 20px; background: rgba(0,0,0,0.8);
        }

        /* STAGE 3: Radar */
        .radar-container {
            position: relative; width: 300px; height: 300px; margin: 30px auto;
            border-radius: 50%;
            background: radial-gradient(transparent 60%, rgba(0, 255, 0, 0.2) 61%), rgba(0, 20, 0, 0.3);
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2); overflow: hidden;
        }
        .radar-scan {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0, 255, 0, 0.5) 30deg, transparent 31deg);
            animation: radar-spin 2s linear infinite;
        }
        .compass-rose { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: transform 0.1s linear; }
        .north-mark { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: var(--primary-color); font-weight: bold; font-size: 1.2rem; }
        .lock-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 280px; height: 280px; border-radius: 50%;
            border: 2px dashed rgba(255, 0, 0, 0.3); transition: all 0.3s;
        }
        .lock-active { border-color: var(--primary-color); border-width: 5px; box-shadow: 0 0 20px var(--primary-color); }

        /* ====================
           STAGE 4: CYBERPUNK SWITCH (REMASTERED)
           ==================== */
        .switch-frame {
            position: relative; width: 280px; height: 420px; margin-top: 20px;
            background: #111;
            /* å·¥æ¥­é¢¨åˆ‡è§’å¤–æ¡† */
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
            border: 2px solid #333;
            /* é‚Šæ¡†å‹•æ…‹å…‰æšˆ */
            box-shadow: 0 0 calc(10px + 20px * var(--tension-level)) rgba(255, 50, 50, var(--tension-level));
            overflow: hidden; perspective: 1000px;
        }

        /* å…§éƒ¨è£é£¾ï¼šç¶²æ ¼èˆ‡è­¦ç¤º */
        .panel-bg {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: 
                linear-gradient(rgba(50,50,50,0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(50,50,50,0.5) 1px, transparent 1px);
            background-size: 20px 20px; opacity: 0.3; z-index: 0;
        }
        .hazard-sides {
            position: absolute; top:0; bottom:0; width: 20px;
            background: repeating-linear-gradient(45deg, #000, #000 10px, #b8860b 10px, #b8860b 20px);
            z-index: 1; opacity: 0.8;
        }
        .hazard-left { left: 0; border-right: 1px solid #555; }
        .hazard-right { right: 0; border-left: 1px solid #555; }

        /* è»Œé“æ§½ */
        .track-channel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 320px;
            background: #000;
            border: 2px solid #444; border-radius: 4px;
            box-shadow: inset 0 0 20px #000;
            z-index: 2;
        }
        /* è»Œé“ä¸­å¿ƒèƒ½é‡æµ */
        .energy-stream {
            position: absolute; left: 50%; top: 10px; bottom: 10px; width: 6px; transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.2);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.2);
            border-radius: 3px;
        }
        /* ç•¶æ‹‰å‹•æ™‚ï¼Œèƒ½é‡æµè®Šå¼· */
        .energy-stream.active {
            background: rgba(255, 0, 0, 0.8);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 0 40px rgba(255, 0, 0, 0.5);
        }

        /* é–˜åˆ€æ‰‹æŸ„ (Energy Cell Style) */
        .lever-handle {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 110px; height: 70px;
            z-index: 10; cursor: grab; touch-action: none;
        }
        
        .handle-body {
            width: 100%; height: 100%;
            background: linear-gradient(180deg, #222 0%, #111 100%);
            border: 2px solid #555; border-radius: 6px;
            /* æ ¹æ“šæ‹‰å‹•ç¨‹åº¦ç™¼ç´…å…‰ */
            box-shadow: 0 0 calc(10px * var(--tension-level)) rgba(255, 0, 0, var(--tension-level));
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        
        /* æ‰‹æŸ„ä¸­é–“çš„èƒ½é‡æ ¸å¿ƒ */
        .handle-core {
            width: 80%; height: 60%;
            background: repeating-linear-gradient(90deg, 
                rgba(255,0,0,0.1), rgba(255,0,0,0.1) 2px, 
                transparent 2px, transparent 5px);
            border: 1px solid rgba(255,0,0,0.3);
            box-shadow: inset 0 0 10px rgba(255,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
        }
        .handle-text {
            color: rgba(255, 255, 255, 0.7); font-family: var(--tech-font); font-size: 0.8rem; letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(255,0,0,0.5); pointer-events: none;
        }
        
        /* æ ¸å¿ƒéè¼‰å‹•ç•« */
        .lever-handle.surging .handle-core {
            background: #ff0000;
            box-shadow: 0 0 30px #ff0000;
            animation: pulse-core 0.1s infinite;
        }

        /* å®‰å…¨è“‹ */
        .safety-cover {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20;
            transform-origin: top center; transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            background: rgba(0, 20, 30, 0.6);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(0, 255, 255, 0.3);
            display: flex; align-items: center; justify-content: center;
        }
        .safety-cover::before { /* æƒæç·šç´‹è·¯ */
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,255,0.05) 3px);
            pointer-events: none;
        }
        .safety-cover.open { transform: rotateX(110deg); opacity: 0.2; pointer-events: none; }
        .lock-icon { font-size: 3rem; color: var(--secondary-color); text-shadow: 0 0 20px var(--secondary-color); }

        /* --- å…‰çˆ†ç‰¹æ•ˆ (Light Bloom) --- */
        #light-bloom {
            position: absolute; left: 50%; bottom: 60px; /* ä½æ–¼è»Œé“åº•éƒ¨ */
            width: 10px; height: 10px; border-radius: 50%;
            background: #fff;
            transform: translate(-50%, 50%) scale(0);
            pointer-events: none; z-index: 999;
            box-shadow: 0 0 50px 20px #fff;
        }
        .bloom-active { animation: lightExplosion 3s forwards cubic-bezier(0.1, 0, 0.9, 1); }

        /* å…¨ç™½é®ç½© (é…åˆå…‰çˆ†ä½¿ç”¨) */
        #whiteout-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 10000; opacity: 0; pointer-events: none;
            mix-blend-mode: normal;
        }
        .whiteout-fade-in { animation: smoothFadeIn 0.5s 0.2s forwards linear; }

        /* Dialog System */
        #dialog-layer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9995;
            display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        #dialog-box {
            position: relative; width: 94%; margin: 0 auto 20px auto;
            background: linear-gradient(180deg, rgba(0, 20, 30, 0.95) 0%, rgba(0, 10, 15, 0.98) 100%);
            border: 2px solid var(--secondary-color); border-bottom: 4px solid var(--primary-color);
            padding: 20px; pointer-events: auto; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        .speaker { 
            font-family: var(--tech-font); font-size: 0.9rem; padding: 4px 10px; margin-bottom: 10px; 
            display: inline-block; background: var(--secondary-color); color: #000; font-weight: bold;
        }
        .dialog-text { font-size: 1.2rem; color: #e0ffe0; min-height: 3.6rem; text-shadow: 0 0 2px rgba(0, 255, 0, 0.5); white-space: pre-wrap; line-height: 1.4; }
        .next-arrow { position: absolute; bottom: 10px; right: 15px; font-size: 1.5rem; color: var(--secondary-color); animation: bounce 1s infinite; }
        
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        #flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; opacity: 0; pointer-events: none; z-index: 9999; mix-blend-mode: hard-light; }
        .flash-active { animation: flashPlateau 4s forwards; }

        @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes shake { 0% { transform: translate(2px, 2px) rotate(0deg); } 25% { transform: translate(-2px, -2px) rotate(-2deg); } 50% { transform: translate(-2px, 2px) rotate(2deg); } 75% { transform: translate(2px, -2px) rotate(-1deg); } 100% { transform: translate(0, 0) rotate(0); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }
        @keyframes flashPlateau { 0% { opacity: 0; } 20% { opacity: 1; } 60% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes pulse-core { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
        
        /* å…‰çˆ†å‹•ç•«ï¼šå¾ä¸­å¿ƒæ“´æ•£ï¼Œæ¨¡æ“¬éæ› */
        @keyframes lightExplosion {
            0% { transform: translate(-50%, 50%) scale(0); opacity: 1; }
            10% { transform: translate(-50%, 50%) scale(5); opacity: 1; } 
            40% { transform: translate(-50%, 50%) scale(50); opacity: 1; } /* åå™¬è¢å¹• */
            100% { transform: translate(-50%, 50%) scale(100); opacity: 1; }
        }
        @keyframes smoothFadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }

        /* æœ€çµ‚éæ›æ•ˆæœ (åœ¨ JS ä¸­å‹•æ…‹åŠ å…¥) */
        .content-overexposed {
            transition: filter 0.2s ease-in;
            filter: brightness(500%) contrast(200%) grayscale(100%) !important;
        }

    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="glow-text" style="font-size: 1.5rem; animation: shake 2s infinite;">SYSTEM INITIALIZING</div>
        <div id="status-log" style="color: var(--secondary-color); margin-top:10px;">LOADING MODULES...</div>
        <button id="start-btn" class="cyber-btn hidden">INITIALIZE LINK</button>
    </div>

    <div id="flash-overlay"></div>
    <div id="whiteout-layer"></div>

    <div id="content-layer">
        
        <div id="stage-1" class="stage-box hidden">
            <h2 class="glow-text">æ™‚ç©ºéŒ¨é»å»ºç«‹</h2>
            <div id="gps-area">
                <div style="font-size: 4rem; margin: 20px; color: var(--secondary-color);">ğŸ›°ï¸</div>
                <div id="gps-msg" class="glow-text" style="color: var(--accent-color);">WAITING FOR SIGNAL...</div>
                <button id="gps-retry-btn" class="cyber-btn hidden">RE-SCAN</button>
            </div>
            <div id="scratch-area" class="hidden" style="opacity: 0; transition: opacity 1s;">
                <div class="scratch-container">
                    <img id="img-base" style="width:100%; height:100%; object-fit:cover; filter: sepia(1) hue-rotate(180deg) contrast(1.2);" />
                    <canvas id="cvs-cover" style="position:absolute; top:0; left:0; width:100%; height:100%; touch-action:none;"></canvas>
                </div>
                <p id="scratch-progress">SYNC: 0%</p>
            </div>
        </div>

        <div id="stage-2" class="stage-box hidden">
            <h2 class="glow-text">å…‰è­œé »ç‡èª¿æ ¡</h2>
            <div id="roulette-msg" class="target-display">TARGET: AWAITING INPUT...</div>
            <div class="roulette-container">
                <div class="pointer"></div>
                <div id="color-wheel"></div>
            </div>
            <button id="roulette-btn" class="cyber-btn">âš¡ LOCK FREQUENCY</button>
        </div>

        <div id="stage-3" class="stage-box hidden">
            <h2 class="glow-text">çµ‚ç«¯é›·é”é–å®š</h2>
            <p style="color: var(--secondary-color);">TARGET: NORTH (åŒ—æ–¹)</p>
            <div class="radar-container">
                <div class="radar-scan"></div>
                <div class="lock-indicator" id="radar-lock-ring"></div>
                <div class="compass-rose" id="compass-ui">
                    <div class="north-mark">N</div>
                    <div style="position: absolute; bottom: 10px; left:50%; transform:translateX(-50%); color:rgba(0,255,0,0.5);">S</div>
                    <div style="position:absolute; top:50%; left:10%; width:80%; height:1px; background:rgba(0,255,0,0.3);"></div>
                    <div style="position:absolute; left:50%; top:10%; height:80%; width:1px; background:rgba(0,255,0,0.3);"></div>
                </div>
            </div>
            <button id="radar-btn" class="cyber-btn" disabled style="opacity: 0.5;">SEARCHING...</button>
        </div>

        <div id="stage-4" class="stage-box hidden">
            <h2 class="glow-text" style="color:var(--warn-color); margin-bottom: 5px;">MANUAL OVERRIDE</h2>
            <div id="instruction-msg" style="font-size: 0.9rem; letter-spacing: 1px; color: #888; margin-bottom: 20px;">[WAITING FOR AUTH]</div>
            
            <div class="switch-frame">
                <div class="panel-bg"></div>
                <div class="hazard-sides hazard-left"></div>
                <div class="hazard-sides hazard-right"></div>
                
                <div class="track-channel">
                    <div id="energy-stream" class="energy-stream"></div>
                    <div id="light-bloom"></div>

                    <div id="lever-handle" class="lever-handle">
                        <div class="handle-body">
                            <div class="handle-core">
                                <span class="handle-text">///</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="safety-cover" class="safety-cover">
                    <div style="text-align:center;">
                        <div class="lock-icon">ğŸ”’</div>
                        <div style="margin-top:10px; font-family:var(--tech-font); color:var(--secondary-color);">SAFETY LOCK ENGAGED</div>
                        <div style="font-size:0.8rem; color:#aaa; margin-top:5px;">TAP TO RELEASE</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dialog-layer" class="hidden">
        <div id="dialog-box">
            <div id="speaker-name" class="speaker">SYSTEM</div>
            <div id="dialog-text-container" class="dialog-text"></div>
            <div id="next-arrow" class="next-arrow hidden">â–¼</div>
        </div>
    </div>

    <script>
        const CONFIG = {
            liffId: "2008882930-UEAr0VU4", // â˜… è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
            devMode: true,
            targetGPS: { lat: 22.615556, lng: 120.265833 }, 
            gpsRadius: 1000000, 
            scratchThreshold: 90,
            glitchClicksReq: 15,
            radarHoldTime: 2000
        };

        const ASSETS = { images: { modern: null, old: null } };
        const SCRIPTS = {
            intro: [
                { name: "é˜¿æ°´ (èªéŸ³é›œè¨Š)", text: "ï¼ˆæ»‹...ï¼‰ä¸è¡Œï¼åº§æ¨™å°ä¸ä¸Š... æ™‚ç©ºäº‚æµå¤ªå¼·äº†ï¼" },
                { name: "ç³»çµ±AI", text: "å•Ÿå‹•ç¾åœ°èªè­‰å”è­°ã€‚æ­£åœ¨æƒæ GPS é »æ®µ..." }
            ],
            gpsSuccess: [
                { name: "ç³»çµ±AI", text: "ä½ç½®ç¢ºèªï¼šæ——å¾Œå±±é ‚ç¯€é»ã€‚åµæ¸¬åˆ°é«˜å¯†åº¦æ™‚ç©ºé®è”½åŠ›å ´ã€‚" }
            ],
            scratchIntro: [
                { name: "é˜¿æ°´", text: "é€£ä¸Šäº†ï¼...ä½†æˆ‘é€™è£¡çœ‹åˆ°çš„æ™¯è±¡å……æ»¿é›œè¨Š... æ“ä½œå“¡ï¼Œç”¨æ‰‹æŒ‡åˆ®é–‹å½è£åœ–å±¤ï¼" }
            ],
            stage1Clear: [
                { name: "é˜¿æ°´", text: "é›œè¨Šæ¸…é™¤äº†ï¼ç¾åœ¨éœ€è¦èª¿æ•´å…‰è­œé »ç‡ï¼" },
                { name: "ç³»çµ±AI", text: "å…‰è­œè½‰ç›¤ä»‹é¢å•Ÿå‹•ã€‚ç­‰å¾…é »ç‡è¼¸å…¥..." }
            ],
            glitchStart: [
                { name: "ç³»çµ±è­¦å ±", text: "âš ï¸ è­¦å‘Šï¼šæ™‚ç©ºå¥‡ç•°é»æ¥è¿‘ï¼è¿´è·¯è¶…è¼‰ï¼" },
                { name: "é˜¿æ°´", text: "è¨Šè™ŸæŠ“ä¸ä½ï¼è½‰ç›¤è¦å¤±æ§äº†ï¼å¿«æŒ‰ä½ç©©å®šå™¨ï¼ï¼" }
            ],
            round2Start: [
                { name: "ç³»çµ±AI", text: "è¿´è·¯ç©©å®šã€‚ç¬¬ä¸€éšæ®µé »ç‡é–å®šã€‚" }
            ],
            stage2Clear: [
                { name: "ç³»çµ±AI", text: "é›™é‡å…‰è­œé–å®šå®Œæˆã€‚SYNC COMPLETEã€‚" },
                { name: "é˜¿æ°´", text: "å…‰æŸæº–å‚™ç™¼å°„äº†ï¼å¿«ç¢ºèªã€åŒ—æ–¹ (N)ã€åœ¨å“ªè£¡ï¼ŒæŠŠæ‰‹æ©Ÿå°æº–é‚£å€‹æ–¹å‘ï¼" }
            ],
            final: [
                { name: "ç³»çµ±AI", text: "é–å®šå®Œæˆã€‚ç™¼å°„è·¯å¾‘æ ¡æ­£å®Œç•¢ã€‚" },
                { name: "ç²½å“¥", text: "å¥½ï¼Œå°±æ˜¯ç¾åœ¨ï¼ç¸½é–‹é—œçš„å®‰å…¨è“‹å·²ç¶“è§£é–äº†ï¼" },
                { name: "é˜¿æ°´", text: "æ“ä½œå“¡ï¼Œæ‰“é–‹è“‹å­ï¼ŒæŠŠé‚£å€‹é–˜åˆ€ç”¨åŠ›æ‹‰åˆ°åº•ï¼è®“å…‰æŸå°„å‡ºå»ï¼" }
            ]
        };

        const els = {
            loading: document.getElementById('loading-screen'),
            startBtn: document.getElementById('start-btn'),
            flash: document.getElementById('flash-overlay'),
            content: document.getElementById('content-layer'),
            dialogLayer: document.getElementById('dialog-layer'),
            dialogBox: document.getElementById('dialog-box'),
            speaker: document.getElementById('speaker-name'),
            text: document.getElementById('dialog-text-container'),
            arrow: document.getElementById('next-arrow'),
            stage1: document.getElementById('stage-1'),
            stage2: document.getElementById('stage-2'),
            stage3: document.getElementById('stage-3'),
            wheel: document.getElementById('color-wheel'),
            rouletteBtn: document.getElementById('roulette-btn'),
            rouletteMsg: document.getElementById('roulette-msg'),
            compassUI: document.getElementById('compass-ui'),
            radarLock: document.getElementById('radar-lock-ring'),
            radarBtn: document.getElementById('radar-btn'),
            // Stage 4 Elements
            stage4: document.getElementById('stage-4'),
            safetyCover: document.getElementById('safety-cover'),
            leverHandle: document.getElementById('lever-handle'),
            whiteout: document.getElementById('whiteout-layer'),
            instruction: document.getElementById('instruction-msg'),
            energyStream: document.getElementById('energy-stream'),
            lightBloom: document.getElementById('light-bloom')
        };

        let scriptQueue = [], onScriptEnd = null, isTyping = false, typingTimer = null, currentFullText = "";

        async function init() {
            try {
                await liff.init({ liffId: CONFIG.liffId });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                els.startBtn.classList.remove('hidden');
                document.getElementById('status-log').innerText = "SYSTEM READY";
            } catch (e) { if(CONFIG.devMode) els.startBtn.classList.remove('hidden'); }
        }
        
        els.startBtn.onclick = () => {
            els.loading.classList.add('hidden');
            els.stage1.classList.remove('hidden');
            playScript(SCRIPTS.intro, checkGPS);
        };

        function playScript(script, callback) {
            scriptQueue = [...script]; onScriptEnd = callback;
            els.dialogLayer.classList.remove('hidden'); els.content.classList.add('content-dimmed');
            nextDialog();
        }

        function nextDialog() {
            if (scriptQueue.length === 0) {
                els.dialogLayer.classList.add('hidden'); els.content.classList.remove('content-dimmed');
                if (onScriptEnd) onScriptEnd(); return;
            }
            const line = scriptQueue.shift();
            els.speaker.innerText = line.name; currentFullText = line.text;
            
            if(line.name.includes("é˜¿æ°´")) { els.speaker.style.background="var(--primary-color)"; els.speaker.style.color="#000"; }
            else if(line.name.includes("è­¦å ±")) { els.speaker.style.background="var(--warn-color)"; els.speaker.style.color="#FFF"; }
            else { els.speaker.style.background="var(--secondary-color)"; els.speaker.style.color="#000"; }
            startTyping(currentFullText);
        }

        function startTyping(txt) {
            isTyping = true; els.text.innerHTML = ""; els.arrow.classList.add('hidden');
            let i = 0; clearInterval(typingTimer);
            typingTimer = setInterval(() => {
                els.text.innerText = txt.substring(0, i+1); i++;
                if(i >= txt.length) { clearInterval(typingTimer); isTyping = false; els.arrow.classList.remove('hidden'); }
            }, 30);
        }

        els.dialogBox.onclick = () => {
            if(isTyping) { clearInterval(typingTimer); els.text.innerText = currentFullText; isTyping = false; els.arrow.classList.remove('hidden'); }
            else { nextDialog(); }
        };

        function checkGPS() {
            const msg = document.getElementById('gps-msg');
            msg.innerText = "COORDINATES ACQUIRED"; msg.style.color = "var(--primary-color)";
            setTimeout(() => playScript(SCRIPTS.gpsSuccess, initScratch), 1000);
        }

        function initScratch() {
            document.getElementById('gps-area').classList.add('hidden');
            document.getElementById('scratch-area').classList.remove('hidden');
            setTimeout(() => document.getElementById('scratch-area').style.opacity = 1, 100);
            
            const canvas = document.getElementById('cvs-cover');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const drawLayer = () => {
                ctx.fillStyle = '#111'; ctx.fillRect(0, 0, rect.width, rect.height); 
                ctx.fillStyle = 'var(--secondary-color)'; ctx.font = "20px monospace"; 
                ctx.fillText("MASK LAYER", 50, 100); 
            };
            drawLayer();

            let isDrawing = false, finished = false;
            const getPos = (e) => { const r = canvas.getBoundingClientRect(); return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top }; };
            canvas.addEventListener('touchstart', (e) => { isDrawing = true; e.preventDefault(); ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); }, {passive:false});
            canvas.addEventListener('touchmove', (e) => { if(!isDrawing || finished) return; e.preventDefault(); const p = getPos(e); ctx.globalCompositeOperation = 'destination-out'; ctx.lineWidth = 60; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineTo(p.x, p.y); ctx.stroke(); ctx.beginPath(); ctx.arc(p.x, p.y, 30, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.moveTo(p.x, p.y); }, {passive:false});
            canvas.addEventListener('touchend', () => { isDrawing = false; if(!finished) checkProgress(); });

            function checkProgress() {
                const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
                let transparent = 0;
                for(let i=3; i<data.length; i+=160) if(data[i] < 128) transparent++;
                const pct = Math.floor((transparent/(data.length/160))*100);
                document.getElementById('scratch-progress').innerText = `SYNC: ${pct}%`;
                if(pct >= CONFIG.scratchThreshold) { finished = true; finishStage1(); }
            }
            playScript(SCRIPTS.scratchIntro);
        }

        function finishStage1() {
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
            triggerFlashTransition('stage-1', 'stage-2');
            setTimeout(() => playScript(SCRIPTS.stage1Clear, initRoulette), 2000);
        }

        function triggerFlashTransition(hideId, showId) {
            els.flash.classList.add('flash-active');
            setTimeout(() => { document.getElementById(hideId).classList.add('hidden'); document.getElementById(showId).classList.remove('hidden'); }, 1500);
            setTimeout(() => els.flash.classList.remove('flash-active'), 4000);
        }

        // --- ROULETTE (Stage 2) ---
        let rState = { angle: 0, speed: 3, running: false, mode: 'normal', lockedColor: null, targetColor: null, glitchCount: 0 };
        let animFrame;

        function initRoulette() {
            rState.mode = 'round1'; rState.speed = 3; rState.running = true; 
            els.rouletteMsg.innerText = "TARGET: AWAITING INPUT...";
            gameLoop();
            els.rouletteBtn.onclick = handleRouletteClick;
        }

        function gameLoop() {
            if (!rState.running) return;
            rState.angle = (rState.angle + rState.speed) % 360;
            if (rState.angle < 0) rState.angle += 360;
            els.wheel.style.transform = `rotate(${rState.angle}deg)`;
            animFrame = requestAnimationFrame(gameLoop);
        }

        function handleRouletteClick() {
            if (rState.mode === 'glitch') {
                rState.glitchCount++;
                rState.speed = rState.speed > 0 ? rState.speed - 2 : rState.speed + 2; 
                if(navigator.vibrate) navigator.vibrate(50);
                let progress = Math.min(100, Math.floor((rState.glitchCount / CONFIG.glitchClicksReq) * 100));
                els.rouletteBtn.innerText = `STABILIZING... ${progress}%`;
                if (rState.glitchCount >= CONFIG.glitchClicksReq) {
                    rState.running = false; cancelAnimationFrame(animFrame);
                    els.rouletteBtn.classList.remove('glitch-mode'); 
                    els.rouletteBtn.innerText = "âš¡ LOCK FREQUENCY";
                    setTimeout(() => playScript(SCRIPTS.round2Start, startRound2), 500);
                }
                return;
            }

            // Simple hit logic for demo
            let effectiveAngle = (360 - rState.angle) % 360;
            let hit = (rState.mode === 'round1') || (rState.mode === 'round2' && effectiveAngle >= 120); // ç°¡åŒ–åˆ¤å®šæ–¹ä¾¿æ¸¬è©¦

            if (true) { // Always hit for UX testing flow
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                rState.running = false; cancelAnimationFrame(animFrame);
                
                if (rState.mode === 'round1') {
                    rState.lockedColor = 'red';
                    els.rouletteMsg.innerText = `LOCKED: RED`;
                    els.rouletteMsg.style.color = "#F00";
                    setTimeout(() => playScript(SCRIPTS.glitchStart, () => {
                        rState.running = true; rState.mode = 'glitch'; 
                        rState.speed = 30; rState.glitchCount = 0;
                        els.rouletteBtn.innerText = "âš ï¸ STABILIZE âš ï¸"; 
                        els.rouletteBtn.classList.add('glitch-mode');
                        gameLoop();
                    }), 1000);
                } else if (rState.mode === 'round2') {
                    els.rouletteMsg.innerText = "SYNC COMPLETE"; 
                    els.rouletteMsg.style.color = "#0F0";
                    setTimeout(finishStage2, 1000);
                }
            }
        }

        function startRound2() {
            rState.mode = 'round2'; rState.speed = -15; rState.running = true;
            els.rouletteMsg.innerText = `TARGET: 2nd COLOR`;
            gameLoop();
        }

        function finishStage2() {
            triggerFlashTransition('stage-2', 'stage-3');
            setTimeout(() => playScript(SCRIPTS.stage2Clear, initRadar), 2000);
        }

        // --- RADAR (Stage 3) ---
        let lockTimer = null;
        function initRadar() {
            els.radarBtn.innerText = "ACTIVATE SENSORS";
            els.radarBtn.disabled = false; els.radarBtn.style.opacity = 1;
            els.radarBtn.onclick = () => { startCompass(); };
        }

        function startCompass() {
            els.radarBtn.innerText = "SEARCHING..."; els.radarBtn.disabled = true; els.radarBtn.style.opacity = 0.5;
            window.addEventListener('deviceorientation', handleOrientation);
            // Fallback for desktop testing: auto lock after 3s
            if(!window.DeviceOrientationEvent) setTimeout(() => { els.compassUI.style.transform = `rotate(0deg)`; handleOrientation({webkitCompassHeading:0}); }, 2000);
        }

        function handleOrientation(e) {
            let heading = e.webkitCompassHeading || Math.abs(e.alpha - 360) || 0;
            els.compassUI.style.transform = `rotate(-${heading}deg)`;
            
            if (heading > 350 || heading < 10) {
                if(els.radarLock.classList.contains('lock-active')) return;
                if (!lockTimer) {
                    els.radarBtn.innerText = "LOCKING... (HOLD)";
                    els.radarBtn.classList.add('locking-mode');
                    if(navigator.vibrate) navigator.vibrate(50);
                    lockTimer = setTimeout(() => {
                        lockTimer = null;
                        els.radarLock.classList.add('lock-active');
                        els.radarBtn.innerText = "ğŸ”’ LOCKED"; 
                        els.radarBtn.style.background = "var(--primary-color)"; 
                        setTimeout(() => { 
                            window.removeEventListener('deviceorientation', handleOrientation); 
                            playScript(SCRIPTS.final, initSwitch); 
                        }, 1000);
                    }, CONFIG.radarHoldTime);
                }
            } else {
                if (lockTimer) { clearTimeout(lockTimer); lockTimer = null; els.radarBtn.classList.remove('locking-mode'); }
            }
        }

        // --- STAGE 4: THE CYBERPUNK SWITCH ---
        function initSwitch() {
            triggerFlashTransition('stage-3', 'stage-4');
            els.instruction.innerText = ">>> TAP SAFETY COVER TO UNLOCK <<<";
            els.instruction.classList.add('glow-text');
            
            els.safetyCover.onclick = () => {
                if(navigator.vibrate) navigator.vibrate(50);
                els.safetyCover.classList.add('open');
                els.instruction.innerText = "DRAG THE HANDLE DOWN TO FIRE";
                els.instruction.style.color = "var(--warn-color)";
                els.energyStream.classList.add('active'); // èƒ½é‡æµé–‹å§‹æµå‹•
                enableLever();
            };
        }

        function enableLever() {
            const handle = els.leverHandle;
            const container = els.stage4;
            const trackHeight = 320; // è»Œé“é«˜åº¦
            const handleHeight = 70; 
            const maxDrag = trackHeight - handleHeight - 20; // 20px padding
            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            handle.addEventListener('touchstart', (e) => {
                isDragging = true;
                startY = e.touches[0].clientY - currentY;
                handle.style.transition = 'none'; 
            });

            handle.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                let y = e.touches[0].clientY - startY;
                y = Math.max(0, Math.min(y, maxDrag));
                currentY = y;
                handle.style.transform = `translateX(-50%) translateY(${y}px)`;
                
                // --- Cyberpunk Dynamic Feedback ---
                let tension = y / maxDrag; // 0.0 ~ 1.0
                document.documentElement.style.setProperty('--tension-level', tension);
                
                if (tension > 0.1) {
                    // æ‰‹æ©Ÿéœ‡å‹•éš¨æ·±åº¦å¢åŠ 
                    if(navigator.vibrate && Math.random() > (1 - tension)) navigator.vibrate(10);
                    // ç•«é¢è¼•å¾®æŠ–å‹•
                    let shake = tension * 2;
                    container.style.transform = `translate(${Math.random()*shake - shake/2}px, ${Math.random()*shake - shake/2}px)`;
                }

                if(tension > 0.8) {
                    handle.classList.add('surging');
                    els.instruction.innerText = "!!! CRITICAL RELEASE !!!";
                } else {
                    handle.classList.remove('surging');
                }
            });

            handle.addEventListener('touchend', () => {
                isDragging = false;
                if (currentY > maxDrag * 0.95) {
                    // å¸é™„åˆ°åº•éƒ¨
                    handle.style.transform = `translateX(-50%) translateY(${maxDrag}px)`;
                    document.documentElement.style.setProperty('--tension-level', 1);
                    triggerFinale();
                } else {
                    // å½ˆå›
                    currentY = 0;
                    handle.style.transition = 'transform 0.3s cubic-bezier(0.5, 0, 0.2, 1)';
                    handle.style.transform = `translateX(-50%) translateY(0px)`;
                    document.documentElement.style.setProperty('--tension-level', 0);
                    handle.classList.remove('surging');
                    container.style.transform = 'none';
                    els.instruction.innerText = "DRAG THE HANDLE DOWN TO FIRE";
                }
            });
        }

        function triggerFinale() {
            // 1. å¼·çƒˆéœ‡å‹• & éš±è—ä»‹é¢
            if(navigator.vibrate) navigator.vibrate([2000]); 
            els.dialogLayer.style.display = 'none';
            els.instruction.innerText = "DISCHARGING...";

            // 2. å…‰çˆ†ç‰¹æ•ˆ (Light Bloom)
            els.lightBloom.classList.add('bloom-active');
            
            // 3. éæ›æ¿¾é¡ (æ¨¡æ“¬ç›¸æ©Ÿè¢«äº®å…‰è‡´ç›²)
            // åœ¨å…‰çˆ†æ“´å¤§åˆ°ä¸€åŠæ™‚ï¼Œè®“èƒŒæ™¯æ•´å€‹éæ›
            setTimeout(() => {
                els.content.classList.add('content-overexposed');
            }, 800);

            // 4. ç´”ç™½é®ç½©é€²å ´ (ç„¡ç¸«æ¥è»Œ)
            setTimeout(() => {
                els.whiteout.classList.add('whiteout-fade-in');
            }, 1200);

            // 5. çµæŸèˆ‡å‚³è¨Š
            setTimeout(() => {
                sendCompletionMessage();
            }, 3000);
        }

        async function sendCompletionMessage() {
            try {
                if (liff.isLoggedIn()) {
                    await liff.sendMessages([{
                        type: 'text',
                        text: "ã€ç³»çµ±æç¤ºã€‘æ™‚ç©ºéŒ¨é»ä¿®æ­£å®Œç•¢ã€‚ç‡ˆå¡”å…‰æŸå·²ç™¼å°„ã€‚\n(Mission Complete)"
                    }]);
                }
            } catch (err) { console.error(err); } 
            finally { liff.closeWindow(); }
        }

        window.onload = init;
    </script>
</body>
</html>
