<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‰πæÂç¶„ÉªÁ†¥Êõâ‰πãÂÖâ | RADAR FIX & PUZZLE</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* ====================
           CYBERPUNK VISUAL CORE
           ==================== */
        :root {
            --primary-color: #0f0;   
            --secondary-color: #0ff; 
            --accent-color: #f0f;    
            --warn-color: #ff2a2a;
            --gold-color: #FFD700;
            --bg-color: #050508;
            --mono-font: 'VT323', monospace;
            --tech-font: 'Orbitron', sans-serif;
            --tension-level: 0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); color: var(--primary-color);
            font-family: var(--mono-font); font-size: 18px;
            overflow: hidden; touch-action: none; user-select: none;
            overscroll-behavior: none;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* CRT Effects */
        body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 9990; pointer-events: none; background-size: 100% 2px, 3px 100%;
        }
        
        .hidden { display: none !important; }
        .glow-text { text-shadow: 0 0 5px var(--secondary-color), 0 0 15px var(--primary-color); }
        
        .cyber-btn {
            padding: 15px 30px; margin-top: 25px;
            font-family: var(--tech-font); font-size: 1.2rem; letter-spacing: 2px;
            color: var(--secondary-color); background: rgba(0, 20, 30, 0.9);
            border: 2px solid var(--secondary-color);
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            cursor: pointer; position: relative; overflow: hidden;
            transition: all 0.1s; text-transform: uppercase;
        }
        .cyber-btn:active { background: var(--secondary-color); color: #000; transform: scale(0.98); }
        .cyber-btn.glitch-mode {
            color: #FFF; background: var(--warn-color); border-color: #FFF;
            box-shadow: 0 0 20px var(--warn-color); animation: shake 0.2s infinite;
        }
        .cyber-btn.locking-mode {
            color: #000; background: #ffff00; border-color: #ffff00;
            box-shadow: 0 0 20px #ffff00;
        }

        #content-layer { width: 100%; height: 100%; transition: filter 0.5s ease; will-change: filter, opacity; }
        .content-dimmed { filter: brightness(0.2) blur(3px) grayscale(50%); }
        .stage-box { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center; 
            padding-bottom: 20vh;
        }

        /* STAGE 1: Scratch */
        .scratch-container {
            width: 85vw; height: 60vw; max-width: 500px; max-height: 350px;
            position: relative; margin: 20px auto;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            background: #000;
        }
        #scratch-progress { font-family: var(--tech-font); color: var(--secondary-color); margin-top: 10px; }

        /* STAGE 2: Roulette */
        .roulette-container {
            position: relative; width: 280px; height: 280px; margin: 30px auto;
            border-radius: 50%; border: 4px solid #333;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.1); overflow: hidden;
        }
        #color-wheel {
            width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(#FF0000 0deg 60deg, #FFFFFF 60deg 120deg, #00FF00 120deg 180deg, #0000FF 180deg 240deg, #111111 240deg 300deg, #555555 300deg 360deg);
        }
        .pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--accent-color);
            filter: drop-shadow(0 0 5px var(--accent-color)); z-index: 10;
        }
        .target-display {
            font-family: var(--tech-font); font-size: 1.5rem; color: #FFF;
            margin-bottom: 10px; border: 1px solid var(--secondary-color); padding: 5px 20px; background: rgba(0,0,0,0.8);
        }

        /* STAGE 3: Radar */
        .radar-container {
            position: relative; width: 300px; height: 300px; margin: 30px auto;
            border-radius: 50%;
            background: radial-gradient(transparent 60%, rgba(0, 255, 0, 0.2) 61%), rgba(0, 20, 0, 0.3);
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2); overflow: hidden;
        }
        .radar-scan {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0, 255, 0, 0.5) 30deg, transparent 31deg);
            animation: radar-spin 2s linear infinite;
        }
        .compass-rose { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: transform 0.1s linear; }
        .north-mark { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: var(--primary-color); font-weight: bold; font-size: 1.2rem; }
        .lock-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 280px; height: 280px; border-radius: 50%;
            border: 2px dashed rgba(255, 0, 0, 0.3); transition: all 0.3s;
        }
        .lock-active { border-color: var(--primary-color); border-width: 5px; box-shadow: 0 0 20px var(--primary-color); }

        /* STAGE 4: Switch */
        .switch-frame {
            position: relative; width: 280px; height: 420px; margin-top: 20px;
            background: #111;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
            border: 2px solid #333;
            box-shadow: 0 0 calc(10px + 20px * var(--tension-level)) rgba(255, 50, 50, var(--tension-level));
            overflow: hidden; perspective: 1000px;
        }
        .panel-bg {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: linear-gradient(rgba(50,50,50,0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(50,50,50,0.5) 1px, transparent 1px);
            background-size: 20px 20px; opacity: 0.3; z-index: 0;
        }
        .hazard-sides {
            position: absolute; top:0; bottom:0; width: 20px;
            background: repeating-linear-gradient(45deg, #000, #000 10px, #b8860b 10px, #b8860b 20px);
            z-index: 1; opacity: 0.8;
        }
        .hazard-left { left: 0; border-right: 1px solid #555; }
        .hazard-right { right: 0; border-left: 1px solid #555; }

        .track-channel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 320px;
            background: #000; border: 2px solid #444; border-radius: 4px;
            box-shadow: inset 0 0 20px #000; z-index: 2;
        }
        .energy-stream {
            position: absolute; left: 50%; top: 10px; bottom: 10px; width: 6px; transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.2); box-shadow: 0 0 10px rgba(255, 0, 0, 0.2);
            border-radius: 3px;
        }
        .energy-stream.active {
            background: rgba(255, 0, 0, 0.8);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 0 40px rgba(255, 0, 0, 0.5);
        }

        .lever-handle {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 110px; height: 70px; z-index: 10; cursor: grab; touch-action: none;
        }
        .handle-body {
            width: 100%; height: 100%;
            background: linear-gradient(180deg, #222 0%, #111 100%);
            border: 2px solid #555; border-radius: 6px;
            box-shadow: 0 0 calc(10px * var(--tension-level)) rgba(255, 0, 0, var(--tension-level));
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .handle-core {
            width: 80%; height: 60%;
            background: repeating-linear-gradient(90deg, rgba(255,0,0,0.1), rgba(255,0,0,0.1) 2px, transparent 2px, transparent 5px);
            border: 1px solid rgba(255,0,0,0.3); box-shadow: inset 0 0 10px rgba(255,0,0,0.2);
            display: flex; align-items: center; justify-content: center; position: relative; overflow: visible;
        }
        .handle-text {
            color: rgba(255, 255, 255, 0.7); font-family: var(--tech-font); font-size: 0.8rem; letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(255,0,0,0.5); pointer-events: none; z-index: 2;
        }
        .lever-handle.surging .handle-core {
            background: #ff0000; box-shadow: 0 0 30px #ff0000; animation: pulse-core 0.1s infinite;
        }

        .safety-cover {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20;
            transform-origin: top center; transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            background: rgba(0, 20, 30, 0.6); backdrop-filter: blur(4px);
            border: 1px solid rgba(0, 255, 255, 0.3); display: flex; align-items: center; justify-content: center;
        }
        .safety-cover::before { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,255,0.05) 3px); pointer-events: none; }
        .safety-cover.open { transform: rotateX(110deg); opacity: 0.2; pointer-events: none; }
        .lock-icon { font-size: 3rem; color: var(--secondary-color); text-shadow: 0 0 20px var(--secondary-color); }

        #light-bloom {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; border-radius: 50%;
            background: #fff; transform: translate(-50%, -50%) scale(0); pointer-events: none; z-index: 100;
            box-shadow: 0 0 20px 10px #fff, 0 0 50px 20px #ffaaaa;
        }
        .bloom-active { animation: lightExplosion 2s forwards cubic-bezier(0.1, 0, 0.2, 1); }

        #whiteout-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 10000; opacity: 0; pointer-events: none;
        }
        .whiteout-fade-in { animation: smoothFadeIn 1s forwards; }

        /* ====================
           PUZZLE UI STYLES (NEW)
           ==================== */
        #puzzle-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 9994; /* Below dialog (9995) */
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }

        .hazard-border {
            position: absolute; top: 0; left: 0; width: 100%; height: 10px;
            background: repeating-linear-gradient(45deg, #000, #000 20px, var(--gold-color) 20px, var(--gold-color) 40px);
            box-shadow: 0 0 15px var(--gold-color);
        }

        .puzzle-box {
            width: 90%; max-width: 360px;
            background: #1a1a1a;
            border: 2px solid #555; border-top: 4px solid var(--gold-color); border-bottom: 4px solid var(--gold-color);
            padding: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8);
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .puzzle-header {
            text-align: center; margin-bottom: 15px;
            font-family: var(--tech-font); color: var(--warn-color); font-weight: bold; font-size: 1.2rem;
            letter-spacing: 2px; text-shadow: 0 0 10px var(--warn-color);
        }

        .blink-warn { animation: blink 1s infinite; }

        .puzzle-screen {
            background: #000; border: 2px inset #333; padding: 15px;
            margin-bottom: 20px; position: relative;
        }

        .mech-info { font-size: 0.7rem; color: #888; font-family: sans-serif; letter-spacing: 1px; margin-bottom: 5px; }
        .example-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dashed #333; padding-bottom: 2px; }
        .label { color: #aaa; font-size: 0.9rem; }
        
        .digital-font {
            font-family: var(--mono-font); font-size: 1.4rem; color: var(--gold-color);
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        .puzzle-divider { height: 1px; background: var(--warn-color); margin: 10px 0; opacity: 0.5; }
        .big-eq { font-size: 1.6rem; color: var(--warn-color); text-align: center; width: 100%; display: block; margin: 10px 0; }

        .input-display {
            background: #220000; color: #FF0000;
            font-family: var(--mono-font); font-size: 2.5rem; text-align: center;
            padding: 5px; border: 1px solid #550000; margin-top: 10px;
            text-shadow: 0 0 10px #FF0000; letter-spacing: 5px;
            height: 60px; line-height: 50px;
        }
        .input-success { background: #002200 !important; color: #00FF00 !important; border-color: #00FF00 !important; text-shadow: 0 0 15px #00FF00 !important; }

        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .num-btn {
            background: #333; color: #FFF; border: 1px solid #555;
            padding: 15px 0; font-family: var(--tech-font); font-size: 1.2rem;
            cursor: pointer; transition: all 0.1s; box-shadow: 0 4px 0 #111;
        }
        .num-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #111; }
        .num-btn.action { background: #554400; color: var(--gold-color); border-color: #776600; }

        /* ====================
           DIALOG & HOLOGRAM
           ==================== */
        #dialog-layer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9995;
            display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        #hologram-container {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            width: 180px; height: 180px; pointer-events: none; z-index: 9996;
            animation: hologram-float 4s ease-in-out infinite;
        }
        
        .hologram-frame {
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--secondary-color); box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            overflow: hidden; opacity: 0.9;
            clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
        }

        .hologram-frame img {
            width: 100%; height: 100%; object-fit: cover;
            filter: contrast(1.2) brightness(1.2) sepia(100%) hue-rotate(180deg) saturate(2);
            mix-blend-mode: hard-light;
        }
        .hologram-frame::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0,255,255,0.1), rgba(0,255,255,0.1) 2px, transparent 2px, transparent 4px);
            background-size: 100% 10px; animation: hologram-scan 1s linear infinite; pointer-events: none;
        }

        #dialog-box {
            position: relative; width: 96%; margin: 0 auto 10px auto;
            background: linear-gradient(180deg, rgba(0, 20, 30, 0.95) 0%, rgba(0, 10, 15, 0.98) 100%);
            border: 2px solid var(--secondary-color); border-bottom: 4px solid var(--primary-color);
            padding: 15px; pointer-events: auto; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            display: flex; flex-direction: column;
        }
        
        .speaker { 
            font-family: var(--tech-font); font-size: 0.9rem; padding: 2px 8px; margin-bottom: 5px; 
            align-self: flex-start; background: var(--secondary-color); color: #000; font-weight: bold;
        }
        .dialog-text { 
            font-size: 1.1rem; color: #e0ffe0; min-height: 3rem; 
            text-shadow: 0 0 2px rgba(0, 255, 0, 0.5); white-space: pre-wrap; line-height: 1.4; 
        }
        .next-arrow { position: absolute; bottom: 10px; right: 10px; font-size: 1.5rem; color: var(--secondary-color); animation: bounce 1s infinite; }
        
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        #flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; opacity: 0; pointer-events: none; z-index: 9999; mix-blend-mode: hard-light; }
        .flash-active { animation: flashPlateau 4s forwards; }

        @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes shake { 0% { transform: translate(2px, 2px) rotate(0deg); } 25% { transform: translate(-2px, -2px) rotate(-2deg); } 50% { transform: translate(-2px, 2px) rotate(2deg); } 75% { transform: translate(2px, -2px) rotate(-1deg); } 100% { transform: translate(0, 0) rotate(0); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }
        @keyframes flashPlateau { 0% { opacity: 0; } 20% { opacity: 1; } 60% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes pulse-core { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
        @keyframes lightExplosion { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(250); opacity: 1; } }
        @keyframes smoothFadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes hologram-scan { 0% { background-position: 0 0; } 100% { background-position: 0 20px; } }
        @keyframes hologram-float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes shake-hard { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        .content-overexposed { transition: filter 1.5s cubic-bezier(0.1, 0, 0.9, 1); filter: brightness(1000%) contrast(50%) grayscale(100%) !important; }

    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="glow-text" style="font-size: 1.5rem; animation: shake 2s infinite;">SYSTEM INITIALIZING</div>
        <div id="status-log" style="color: var(--secondary-color); margin-top:10px;">LOADING MODULES...</div>
        <button id="start-btn" class="cyber-btn hidden">INITIALIZE LINK</button>
    </div>

    <div id="flash-overlay"></div>
    <div id="whiteout-layer"></div>

    <div id="content-layer">
        
        <div id="stage-1" class="stage-box hidden">
            <h2 class="glow-text">ÊôÇÁ©∫Èå®ÈªûÂª∫Á´ã</h2>
            <div id="gps-area">
                <div style="font-size: 4rem; margin: 20px; color: var(--secondary-color);">üõ∞Ô∏è</div>
                <div id="gps-msg" class="glow-text" style="color: var(--accent-color);">WAITING FOR SIGNAL...</div>
                <button id="gps-retry-btn" class="cyber-btn hidden">RE-SCAN</button>
            </div>
            <div id="scratch-area" class="hidden" style="opacity: 0; transition: opacity 1s;">
                <div class="scratch-container">
                    <img id="img-base" style="width:100%; height:100%; object-fit:cover; filter: sepia(1) hue-rotate(180deg) contrast(1.2);" />
                    <canvas id="cvs-cover" style="position:absolute; top:0; left:0; width:100%; height:100%; touch-action:none;"></canvas>
                </div>
                <p id="scratch-progress">SYNC: 0%</p>
            </div>
        </div>

        <div id="stage-2" class="stage-box hidden">
            <h2 class="glow-text">ÂÖâË≠úÈ†ªÁéáË™øÊ†°</h2>
            <div id="roulette-msg" class="target-display">TARGET: AWAITING INPUT...</div>
            <div class="roulette-container">
                <div class="pointer"></div>
                <div id="color-wheel"></div>
            </div>
            <button id="roulette-btn" class="cyber-btn">‚ö° LOCK FREQUENCY</button>
        </div>

        <div id="stage-3" class="stage-box hidden">
            <h2 class="glow-text">ÁµÇÁ´ØÈõ∑ÈÅîÈéñÂÆö</h2>
            <p style="color: var(--secondary-color);">TARGET: NORTH (ÂåóÊñπ)</p>
            <div class="radar-container">
                <div class="radar-scan"></div>
                <div class="lock-indicator" id="radar-lock-ring"></div>
                <div class="compass-rose" id="compass-ui">
                    <div class="north-mark">N</div>
                    <div style="position: absolute; bottom: 10px; left:50%; transform:translateX(-50%); color:rgba(0,255,0,0.5);">S</div>
                    <div style="position:absolute; top:50%; left:10%; width:80%; height:1px; background:rgba(0,255,0,0.3);"></div>
                    <div style="position:absolute; left:50%; top:10%; height:80%; width:1px; background:rgba(0,255,0,0.3);"></div>
                </div>
            </div>
            <button id="radar-btn" class="cyber-btn" disabled style="opacity: 0.5;">SEARCHING...</button>
        </div>

        <div id="stage-4" class="stage-box hidden">
            <h2 class="glow-text" style="color:var(--warn-color); margin-bottom: 5px;">MANUAL OVERRIDE</h2>
            <div id="instruction-msg" style="font-size: 0.9rem; letter-spacing: 1px; color: #888; margin-bottom: 20px;">[WAITING FOR AUTH]</div>
            
            <div class="switch-frame">
                <div class="panel-bg"></div>
                <div class="hazard-sides hazard-left"></div>
                <div class="hazard-sides hazard-right"></div>
                <div class="track-channel">
                    <div id="energy-stream" class="energy-stream"></div>
                    <div id="lever-handle" class="lever-handle">
                        <div class="handle-body">
                            <div class="handle-core">
                                <span class="handle-text">///</span>
                                <div id="light-bloom"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="safety-cover" class="safety-cover">
                    <div style="text-align:center;">
                        <div class="lock-icon">üîí</div>
                        <div style="margin-top:10px; font-family:var(--tech-font); color:var(--secondary-color);">SAFETY LOCK ENGAGED</div>
                        <div style="font-size:0.8rem; color:#aaa; margin-top:5px;">TAP TO RELEASE</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="puzzle-overlay" class="hidden">
        <div class="hazard-border"></div>
        <div class="puzzle-box">
            <div class="puzzle-header">
                <span class="blink-warn">‚ö†Ô∏è SAFETY LOCKDOWN</span>
            </div>
            
            <div class="puzzle-screen">
                <div class="mech-info">TUMBLER MECHANISM CHECK</div>
                
                <div class="example-row">
                    <span class="label">SET A:</span>
                    <span class="digital-font">1 + 1 = 4</span>
                </div>
                <div class="example-row">
                    <span class="label">SET B:</span>
                    <span class="digital-font">7 - 1 = 1</span>
                </div>
                
                <div class="puzzle-divider"></div>
                
                <div class="puzzle-question">
                    <div class="mech-info">MANUAL OVERRIDE CODE</div>
                    <div class="digital-font big-eq">( 8 + 1 ) √ó 7 = ?</div>
                </div>

                <div class="input-display" id="puzzle-input-screen">_ _</div>
            </div>

            <div class="numpad">
                <button class="num-btn" onclick="inputPad(1)">1</button>
                <button class="num-btn" onclick="inputPad(2)">2</button>
                <button class="num-btn" onclick="inputPad(3)">3</button>
                <button class="num-btn" onclick="inputPad(4)">4</button>
                <button class="num-btn" onclick="inputPad(5)">5</button>
                <button class="num-btn" onclick="inputPad(6)">6</button>
                <button class="num-btn" onclick="inputPad(7)">7</button>
                <button class="num-btn" onclick="inputPad(8)">8</button>
                <button class="num-btn" onclick="inputPad(9)">9</button>
                <button class="num-btn action" onclick="inputPad('CLR')">CLR</button>
                <button class="num-btn" onclick="inputPad(0)">0</button>
                <button class="num-btn action" onclick="inputPad('OK')">ENT</button>
            </div>
        </div>
    </div>

    <div id="dialog-layer" class="hidden">
        
        <div id="hologram-container" class="hidden">
            <div class="hologram-frame">
                <img id="char-portrait-img" src="" alt="HOLO_COMM" />
            </div>
        </div>

        <div id="dialog-box">
            <div id="speaker-name" class="speaker">SYSTEM</div>
            <div id="dialog-text-container" class="dialog-text"></div>
            <div id="next-arrow" class="next-arrow hidden">‚ñº</div>
        </div>
    </div>

    <script>
        const CONFIG = {
            liffId: "2008882930-UEAr0VU4", 
            devMode: true,
            targetGPS: { lat: 22.615556, lng: 120.265833 }, 
            gpsRadius: 1000000, 
            scratchThreshold: 90,
            glitchClicksReq: 15,
            radarHoldTime: 2000
        };

        const ASSETS = { images: { modern: null, old: null } };

        // ‚òÖ‚òÖ‚òÖ ËßíËâ≤ÂúñÁâáË®≠ÂÆö ‚òÖ‚òÖ‚òÖ
        const CHAR_IMAGES = {
            "ÈòøÊ∞¥": "https://placehold.co/200x200/003366/00FFFF?text=WATER", 
            "Á≤ΩÂì•": "https://placehold.co/200x200/333300/FFFF00?text=ZONG",  
            "Á≥ªÁµ±AI": "https://placehold.co/200x200/000000/00FF00?text=AI", 
            "Á≥ªÁµ±Ë≠¶Â†±": null 
        };

        const SCRIPTS = {
            intro: [
                { name: "ÈòøÊ∞¥ (Ë™ûÈü≥ÈõúË®ä)", text: "ÔºàÊªã...Ôºâ‰∏çË°åÔºÅÂ∫ßÊ®ôÂ∞ç‰∏ç‰∏ä... ÊôÇÁ©∫‰∫ÇÊµÅÂ§™Âº∑‰∫ÜÔºÅ" },
                { name: "Á≥ªÁµ±AI", text: "ÂïüÂãïÁèæÂú∞Ë™çË≠âÂçîË≠∞„ÄÇÊ≠£Âú®ÊéÉÊèè GPS È†ªÊÆµ..." }
            ],
            gpsSuccess: [
                { name: "Á≥ªÁµ±AI", text: "‰ΩçÁΩÆÁ¢∫Ë™çÔºöÊóóÂæåÂ±±È†ÇÁØÄÈªû„ÄÇÂÅµÊ∏¨Âà∞È´òÂØÜÂ∫¶ÊôÇÁ©∫ÈÅÆËîΩÂäõÂ†¥„ÄÇ" }
            ],
            scratchIntro: [
                { name: "ÈòøÊ∞¥", text: "ÈÄ£‰∏ä‰∫ÜÔºÅ...‰ΩÜÊàëÈÄôË£°ÁúãÂà∞ÁöÑÊôØË±°ÂÖÖÊªøÈõúË®ä... Êìç‰ΩúÂì°ÔºåÁî®ÊâãÊåáÂàÆÈñãÂÅΩË£ùÂúñÂ±§ÔºÅ" }
            ],
            stage1Clear: [
                { name: "ÈòøÊ∞¥", text: "ÈõúË®äÊ∏ÖÈô§‰∫ÜÔºÅÁèæÂú®ÈúÄË¶ÅË™øÊï¥ÂÖâË≠úÈ†ªÁéáÔºÅ" },
                { name: "Á≥ªÁµ±AI", text: "ÂÖâË≠úËΩâÁõ§‰ªãÈù¢ÂïüÂãï„ÄÇÁ≠âÂæÖÈ†ªÁéáËº∏ÂÖ•..." }
            ],
            glitchStart: [
                { name: "Á≥ªÁµ±Ë≠¶Â†±", text: "‚ö†Ô∏è Ë≠¶ÂëäÔºöÊôÇÁ©∫Â•áÁï∞ÈªûÊé•ËøëÔºÅËø¥Ë∑ØË∂ÖËºâÔºÅ" },
                { name: "ÈòøÊ∞¥", text: "Ë®äËôüÊäì‰∏ç‰ΩèÔºÅËΩâÁõ§Ë¶ÅÂ§±Êéß‰∫ÜÔºÅÂø´Êåâ‰ΩèÁ©©ÂÆöÂô®ÔºÅÔºÅ" }
            ],
            round2Start: [
                { name: "Á≥ªÁµ±AI", text: "Ëø¥Ë∑ØÁ©©ÂÆö„ÄÇÁ¨¨‰∏ÄÈöéÊÆµÈ†ªÁéáÈéñÂÆö„ÄÇ" }
            ],
            stage2Clear: [
                { name: "Á≥ªÁµ±AI", text: "ÈõôÈáçÂÖâË≠úÈéñÂÆöÂÆåÊàê„ÄÇSYNC COMPLETE„ÄÇ" },
                { name: "ÈòøÊ∞¥", text: "ÂÖâÊùüÊ∫ñÂÇôÁôºÂ∞Ñ‰∫ÜÔºÅÂø´Á¢∫Ë™ç„ÄéÂåóÊñπ (N)„ÄèÂú®Âì™Ë£°ÔºåÊääÊâãÊ©üÂ∞çÊ∫ñÈÇ£ÂÄãÊñπÂêëÔºÅ" }
            ],
            final: [
                { name: "Á≥ªÁµ±AI", text: "ÈéñÂÆöÂÆåÊàê„ÄÇÁôºÂ∞ÑË∑ØÂæëÊ†°Ê≠£ÂÆåÁï¢„ÄÇ" },
                { name: "Á≤ΩÂì•", text: "Â•ΩÔºåÂ∞±ÊòØÁèæÂú®ÔºÅÁ∏ΩÈñãÈóúÁöÑÂÆâÂÖ®ËìãÂ∑≤Á∂ìËß£Èéñ‰∫ÜÔºÅ" },
                { name: "ÈòøÊ∞¥", text: "Êìç‰ΩúÂì°ÔºåÊâìÈñãËìãÂ≠êÔºåÊääÈÇ£ÂÄãÈñòÂàÄÁî®ÂäõÊãâÂà∞Â∫ïÔºÅËÆìÂÖâÊùüÂ∞ÑÂá∫ÂéªÔºÅ" }
            ],
            puzzleJam: [
                { name: "ÈòøÊ∞¥", text: "ÔºàÁî®ÂäõËÅ≤...ÔºâÊâì‰∏çÈñãÔºÅÈÄôÂÄãËìãÂ≠êÂç°Ê≠ª‰∫ÜÔºÅ" },
                { name: "ÈòøÊ∞¥", text: "ÈéñÈ†≠ÊóÅÈÇä‰∫ÆËµ∑‰∫ÜÂ•áÊÄ™ÁöÑÁ¥ÖÂ≠ó... ÂÆÉÂú®ÊìãËëóÊàëÔºÅ‰∏äÈù¢ÂØ´Ëëó 1 + 1 = 4ÔºüÈÄô‰ªÄÈ∫ºÈ¨ºÁï´Á¨¶Ôºü" },
                { name: "Á≤ΩÂì•", text: "ÈòøÊ∞¥ÔºåÂà•Áî®Ë†ªÂäõ„ÄÇÈÄôÊòØ‰∏ÄÂÄã„ÄéÁµêÊßãÈéñ„Äè„ÄÇ" },
                { name: "Á≤ΩÂì•", text: "{player_name}Ôºå‰ªîÁ¥∞ÁúãÈÇ£‰∫õÊï∏Â≠ó„ÄÇÈÇ£ÂÄãÊ©üÈóú‰∏çÊòØÂú®ÁÆóÊï∏Â≠∏ÔºåÂÆÉÊòØÂú®Ê™¢Ê∏¨ÈéñËäØË£°ÊúâÂπæÊ†π„ÄéÂÖâÊ¢ù (Pins)„Äè„ÄÇ" },
                { name: "Á≤ΩÂì•", text: "ÁÆóÂá∫Ëß£ÈñãÈÄôÈÅìÈéñÁ∏ΩÂÖ±ÈúÄË¶ÅÈÄÄÈñãÂπæÊ†πÂç°Ê¶´ÔºåËº∏ÂÖ•Êï∏Â≠óÊâãÂãïËß£Èô§ÔºÅ" }
            ],
            puzzleSolved: [
                { name: "ÈòøÊ∞¥", text: "Èñã‰∫ÜÔºÅÂç°Ê¶´ÂÖ®ÈÉ®ÈÄÄÈñã‰∫ÜÔºÅ" },
                { name: "ÈòøÊ∞¥", text: "{player_name}ÔºåË∑ØÈÄö‰∫ÜÔºÅÊäìÁ∑äÈñòÂàÄ... ÊääÂÆÉÊãâÂà∞Â∫ïÔºÅÔºÅ" }
            ]
        };

        const els = {
            loading: document.getElementById('loading-screen'),
            startBtn: document.getElementById('start-btn'),
            flash: document.getElementById('flash-overlay'),
            content: document.getElementById('content-layer'),
            dialogLayer: document.getElementById('dialog-layer'),
            dialogBox: document.getElementById('dialog-box'),
            speaker: document.getElementById('speaker-name'),
            text: document.getElementById('dialog-text-container'),
            arrow: document.getElementById('next-arrow'),
            hologramContainer: document.getElementById('hologram-container'), 
            portraitImg: document.getElementById('char-portrait-img'),
            stage1: document.getElementById('stage-1'),
            stage2: document.getElementById('stage-2'),
            stage3: document.getElementById('stage-3'),
            wheel: document.getElementById('color-wheel'),
            rouletteBtn: document.getElementById('roulette-btn'),
            rouletteMsg: document.getElementById('roulette-msg'),
            compassUI: document.getElementById('compass-ui'),
            radarLock: document.getElementById('radar-lock-ring'),
            radarBtn: document.getElementById('radar-btn'),
            stage4: document.getElementById('stage-4'),
            safetyCover: document.getElementById('safety-cover'),
            leverHandle: document.getElementById('lever-handle'),
            whiteout: document.getElementById('whiteout-layer'),
            instruction: document.getElementById('instruction-msg'),
            energyStream: document.getElementById('energy-stream'),
            lightBloom: document.getElementById('light-bloom'),
            puzzleOverlay: document.getElementById('puzzle-overlay'),
            inputScreen: document.getElementById('puzzle-input-screen')
        };

        let scriptQueue = [], onScriptEnd = null, isTyping = false, typingTimer = null, currentFullText = "";

        async function init() {
            try {
                await liff.init({ liffId: CONFIG.liffId });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                els.startBtn.classList.remove('hidden');
                document.getElementById('status-log').innerText = "SYSTEM READY";
            } catch (e) { if(CONFIG.devMode) els.startBtn.classList.remove('hidden'); }
        }
        
        els.startBtn.onclick = () => {
            els.loading.classList.add('hidden');
            els.stage1.classList.remove('hidden');
            playScript(SCRIPTS.intro, checkGPS);
        };

        function playScript(script, callback) {
            scriptQueue = [...script]; onScriptEnd = callback;
            els.dialogLayer.classList.remove('hidden'); els.content.classList.add('content-dimmed');
            nextDialog();
        }

        function nextDialog() {
            if (scriptQueue.length === 0) {
                els.dialogLayer.classList.add('hidden'); els.content.classList.remove('content-dimmed');
                if (onScriptEnd) onScriptEnd(); return;
            }
            const line = scriptQueue.shift();
            
            els.speaker.innerText = line.name; 
            currentFullText = line.text.replace('{player_name}', 'Êìç‰ΩúÂì°'); // Á∞°ÊòìÊõøÊèõÂêçÁ®±
            
            // Âà§Êñ∑ËßíËâ≤‰∏¶Êõ¥Êñ∞ÂúñÁâá
            let imgKey = null;
            if(line.name.includes("ÈòøÊ∞¥")) imgKey = "ÈòøÊ∞¥";
            else if(line.name.includes("Á≤ΩÂì•")) imgKey = "Á≤ΩÂì•";
            else if(line.name.includes("Á≥ªÁµ±AI")) imgKey = "Á≥ªÁµ±AI";
            else if(line.name.includes("Ë≠¶Â†±")) imgKey = "Á≥ªÁµ±Ë≠¶Â†±";

            if(imgKey && CHAR_IMAGES[imgKey]) {
                els.portraitImg.src = CHAR_IMAGES[imgKey];
                els.hologramContainer.classList.remove('hidden');
            } else {
                els.hologramContainer.classList.add('hidden');
            }

            if(line.name.includes("ÈòøÊ∞¥")) { els.speaker.style.background="var(--primary-color)"; els.speaker.style.color="#000"; }
            else if(line.name.includes("Ë≠¶Â†±")) { els.speaker.style.background="var(--warn-color)"; els.speaker.style.color="#FFF"; }
            else { els.speaker.style.background="var(--secondary-color)"; els.speaker.style.color="#000"; }

            startTyping(currentFullText);
        }

        function startTyping(txt) {
            isTyping = true; els.text.innerHTML = ""; els.arrow.classList.add('hidden');
            let i = 0; clearInterval(typingTimer);
            typingTimer = setInterval(() => {
                els.text.innerText = txt.substring(0, i+1); i++;
                if(i >= txt.length) { clearInterval(typingTimer); isTyping = false; els.arrow.classList.remove('hidden'); }
            }, 30);
        }

        els.dialogBox.onclick = () => {
            if(isTyping) { clearInterval(typingTimer); els.text.innerText = currentFullText; isTyping = false; els.arrow.classList.remove('hidden'); }
            else { nextDialog(); }
        };

        function checkGPS() {
            const msg = document.getElementById('gps-msg');
            msg.innerText = "COORDINATES ACQUIRED"; msg.style.color = "var(--primary-color)";
            setTimeout(() => playScript(SCRIPTS.gpsSuccess, initScratch), 1000);
        }

        function initScratch() {
            document.getElementById('gps-area').classList.add('hidden');
            document.getElementById('scratch-area').classList.remove('hidden');
            setTimeout(() => document.getElementById('scratch-area').style.opacity = 1, 100);
            
            const canvas = document.getElementById('cvs-cover');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const drawLayer = () => {
                ctx.fillStyle = '#111'; ctx.fillRect(0, 0, rect.width, rect.height); 
                ctx.fillStyle = 'var(--secondary-color)'; ctx.font = "20px monospace"; 
                ctx.fillText("MASK LAYER", 50, 100); 
            };
            drawLayer();

            let isDrawing = false, finished = false;
            const getPos = (e) => { const r = canvas.getBoundingClientRect(); return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top }; };
            canvas.addEventListener('touchstart', (e) => { isDrawing = true; e.preventDefault(); ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); }, {passive:false});
            canvas.addEventListener('touchmove', (e) => { if(!isDrawing || finished) return; e.preventDefault(); const p = getPos(e); ctx.globalCompositeOperation = 'destination-out'; ctx.lineWidth = 60; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineTo(p.x, p.y); ctx.stroke(); ctx.beginPath(); ctx.arc(p.x, p.y, 30, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.moveTo(p.x, p.y); }, {passive:false});
            canvas.addEventListener('touchend', () => { isDrawing = false; if(!finished) checkProgress(); });

            function checkProgress() {
                const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
                let transparent = 0;
                for(let i=3; i<data.length; i+=160) if(data[i] < 128) transparent++;
                const pct = Math.floor((transparent/(data.length/160))*100);
                document.getElementById('scratch-progress').innerText = `SYNC: ${pct}%`;
                if(pct >= CONFIG.scratchThreshold) { finished = true; finishStage1(); }
            }
            playScript(SCRIPTS.scratchIntro);
        }

        function finishStage1() {
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
            triggerFlashTransition('stage-1', 'stage-2');
            setTimeout(() => playScript(SCRIPTS.stage1Clear, initRoulette), 2000);
        }

        function triggerFlashTransition(hideId, showId) {
            els.flash.classList.add('flash-active');
            setTimeout(() => { document.getElementById(hideId).classList.add('hidden'); document.getElementById(showId).classList.remove('hidden'); }, 1500);
            setTimeout(() => els.flash.classList.remove('flash-active'), 4000);
        }

        // --- ROULETTE (Stage 2) ---
        let rState = { angle: 0, speed: 3, running: false, mode: 'normal', lockedColor: null, targetColor: null, glitchCount: 0 };
        let animFrame;

        function initRoulette() {
            rState.mode = 'round1'; rState.speed = 3; rState.running = true; 
            els.rouletteMsg.innerText = "TARGET: AWAITING INPUT...";
            gameLoop();
            els.rouletteBtn.onclick = handleRouletteClick;
        }

        function gameLoop() {
            if (!rState.running) return;
            rState.angle = (rState.angle + rState.speed) % 360;
            if (rState.angle < 0) rState.angle += 360;
            els.wheel.style.transform = `rotate(${rState.angle}deg)`;
            animFrame = requestAnimationFrame(gameLoop);
        }

        function handleRouletteClick() {
            if (rState.mode === 'glitch') {
                rState.glitchCount++;
                rState.speed = rState.speed > 0 ? rState.speed - 2 : rState.speed + 2; 
                if(navigator.vibrate) navigator.vibrate(50);
                let progress = Math.min(100, Math.floor((rState.glitchCount / CONFIG.glitchClicksReq) * 100));
                els.rouletteBtn.innerText = `STABILIZING... ${progress}%`;
                if (rState.glitchCount >= CONFIG.glitchClicksReq) {
                    rState.running = false; cancelAnimationFrame(animFrame);
                    els.rouletteBtn.classList.remove('glitch-mode'); 
                    els.rouletteBtn.innerText = "‚ö° LOCK FREQUENCY";
                    setTimeout(() => playScript(SCRIPTS.round2Start, startRound2), 500);
                }
                return;
            }

            let effectiveAngle = (360 - rState.angle) % 360;
            let isRed = (effectiveAngle >= 0 && effectiveAngle < 60);
            let isWhite = (effectiveAngle >= 60 && effectiveAngle < 120);
            
            let hit = false;
            let errorMsg = "INVALID FREQUENCY";

            if (rState.mode === 'round1') {
                if (isRed) { hit = true; rState.lockedColor = 'red'; }
                else if (isWhite) { hit = true; rState.lockedColor = 'white'; }
            } else if (rState.mode === 'round2') {
                if (rState.targetColor === 'red' && isRed) hit = true;
                else if (rState.targetColor === 'white' && isWhite) hit = true;
                if ((rState.lockedColor === 'red' && isRed) || (rState.lockedColor === 'white' && isWhite)) 
                    errorMsg = "ÂêåÈ†ªÁéáÂπ≤Êìæ (SAME FREQ)";
            }

            if (hit) {
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                rState.running = false; cancelAnimationFrame(animFrame);
                
                if (rState.mode === 'round1') {
                    rState.targetColor = (rState.lockedColor === 'red') ? 'white' : 'red';
                    let colorName = rState.lockedColor === 'red' ? "RED" : "WHITE";
                    els.rouletteMsg.innerText = `LOCKED: ${colorName}`;
                    els.rouletteMsg.style.color = rState.lockedColor === 'red' ? "#F00" : "#FFF";
                    setTimeout(() => playScript(SCRIPTS.glitchStart, () => {
                        rState.running = true; rState.mode = 'glitch'; 
                        rState.speed = 30; rState.glitchCount = 0;
                        els.rouletteBtn.innerText = "‚ö†Ô∏è STABILIZE ‚ö†Ô∏è"; 
                        els.rouletteBtn.classList.add('glitch-mode');
                        gameLoop();
                    }), 1000);
                } else if (rState.mode === 'round2') {
                    els.rouletteMsg.innerText = "SYNC COMPLETE"; 
                    els.rouletteMsg.style.color = "#0F0";
                    setTimeout(finishStage2, 1000);
                }
            } else {
                if (navigator.vibrate) navigator.vibrate(200);
                let originalText = els.rouletteMsg.innerText;
                els.rouletteMsg.innerText = errorMsg;
                els.rouletteMsg.style.color = "var(--warn-color)";
                els.rouletteBtn.classList.add('glitch-mode'); 
                setTimeout(() => {
                    els.rouletteBtn.classList.remove('glitch-mode');
                    els.rouletteMsg.innerText = originalText;
                    els.rouletteMsg.style.color = "#FFF";
                }, 800);
            }
        }

        function startRound2() {
            rState.mode = 'round2'; rState.speed = -15; rState.running = true;
            els.rouletteMsg.innerText = `TARGET: 2nd COLOR`;
            gameLoop();
        }

        function finishStage2() {
            triggerFlashTransition('stage-2', 'stage-3');
            setTimeout(() => playScript(SCRIPTS.stage2Clear, initRadar), 2000);
        }

        // --- RADAR (Stage 3) + iOS Permission Fix ---
        let lockTimer = null;
        function initRadar() {
            els.radarBtn.innerText = "ACTIVATE SENSORS";
            els.radarBtn.disabled = false; els.radarBtn.style.opacity = 1;
            els.radarBtn.onclick = () => { startCompass(); };
        }

        function startCompass() {
            // iOS 13+ Ê¨äÈôêË´ãÊ±ÇÈÇèËºØ
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            activateCompassListener();
                        } else {
                            alert("Ë´ãÂÖÅË®±ÁæÖÁõ§Ê¨äÈôê‰ª•ÈÄ≤Ë°åÂÆö‰ΩçÔºÅ");
                        }
                    })
                    .catch(console.error);
            } else {
                // Android ÊàñÈùû iOS 13+
                activateCompassListener();
            }
        }

        function activateCompassListener() {
            els.radarBtn.innerText = "SEARCHING..."; 
            els.radarBtn.disabled = true; 
            els.radarBtn.style.opacity = 0.5;
            window.addEventListener('deviceorientation', handleOrientation);
            // Fallback for desktop testing
            if(!window.DeviceOrientationEvent) setTimeout(() => { els.compassUI.style.transform = `rotate(0deg)`; handleOrientation({webkitCompassHeading:0}); }, 2000);
        }

        function handleOrientation(e) {
            let heading = e.webkitCompassHeading || Math.abs(e.alpha - 360) || 0;
            els.compassUI.style.transform = `rotate(-${heading}deg)`;
            
            if (heading > 350 || heading < 10) {
                if(els.radarLock.classList.contains('lock-active')) return;
                if (!lockTimer) {
                    els.radarBtn.innerText = "LOCKING... (HOLD)";
                    els.radarBtn.classList.add('locking-mode');
                    if(navigator.vibrate) navigator.vibrate(50);
                    lockTimer = setTimeout(() => {
                        lockTimer = null;
                        els.radarLock.classList.add('lock-active');
                        els.radarBtn.innerText = "üîí LOCKED"; 
                        els.radarBtn.style.background = "var(--primary-color)"; 
                        setTimeout(() => { 
                            window.removeEventListener('deviceorientation', handleOrientation); 
                            playScript(SCRIPTS.final, initSwitch); 
                        }, 1000);
                    }, CONFIG.radarHoldTime);
                }
            } else {
                if (lockTimer) { clearTimeout(lockTimer); lockTimer = null; els.radarBtn.classList.remove('locking-mode'); }
            }
        }

        // --- STAGE 4: SWITCH & PUZZLE ---
        let isPuzzleSolved = false;
        let currentInput = "";

        function initSwitch() {
            triggerFlashTransition('stage-3', 'stage-4');
            els.instruction.innerText = ">>> TAP SAFETY COVER TO UNLOCK <<<";
            els.instruction.classList.add('glow-text');
            els.safetyCover.onclick = handleSafetyClick;
        }

        function handleSafetyClick() {
            if (isPuzzleSolved) {
                openSafetyCoverVisuals();
            } else {
                triggerPuzzleSequence();
            }
        }

        function triggerPuzzleSequence() {
            if(navigator.vibrate) navigator.vibrate([50, 50, 50, 200]);
            els.safetyCover.style.animation = "shake-hard 0.5s";
            els.instruction.innerText = "‚ö†Ô∏è ERROR: MECHANISM JAMMED";
            els.instruction.style.color = "var(--warn-color)";
            setTimeout(() => { els.safetyCover.style.animation = ""; }, 500);

            playScript(SCRIPTS.puzzleJam, () => {
                els.puzzleOverlay.classList.remove('hidden');
            });
        }

        window.inputPad = function(val) {
            if(isPuzzleSolved) return;
            const screen = els.inputScreen;
            if (val === 'CLR') {
                currentInput = "";
                if(navigator.vibrate) navigator.vibrate(20);
            } else if (val === 'OK') {
                checkAnswer();
            } else {
                if (currentInput.length < 2) {
                    currentInput += val;
                    if(navigator.vibrate) navigator.vibrate(20);
                }
            }
            screen.innerText = currentInput === "" ? "_ _" : currentInput;
        }

        function checkAnswer() {
            if (currentInput === "27") {
                solvePuzzle();
            } else {
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                const screen = els.inputScreen;
                screen.style.color = "var(--warn-color)";
                screen.style.borderColor = "var(--warn-color)";
                setTimeout(() => {
                    currentInput = "";
                    screen.innerText = "_ _";
                    screen.style.color = "#FF0000";
                    screen.style.borderColor = "#550000";
                }, 500);
            }
        }

        function solvePuzzle() {
            isPuzzleSolved = true;
            const screen = els.inputScreen;
            screen.innerText = "OPEN";
            screen.classList.add('input-success');
            if(navigator.vibrate) navigator.vibrate([50, 50, 50, 50, 200]);
            
            setTimeout(() => {
                els.puzzleOverlay.classList.add('hidden');
                playScript(SCRIPTS.puzzleSolved, () => {
                    openSafetyCoverVisuals();
                });
            }, 1000);
        }

        function openSafetyCoverVisuals() {
            if(navigator.vibrate) navigator.vibrate(50);
            els.safetyCover.classList.add('open');
            els.instruction.innerText = "DRAG THE HANDLE DOWN TO FIRE";
            els.instruction.style.color = "var(--warn-color)";
            els.energyStream.classList.add('active'); 
            enableLever();
            els.safetyCover.onclick = null;
        }

        function enableLever() {
            const handle = els.leverHandle;
            const container = els.stage4;
            const trackHeight = 320; 
            const handleHeight = 70; 
            const maxDrag = trackHeight - handleHeight - 20; 
            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            handle.addEventListener('touchstart', (e) => {
                isDragging = true;
                startY = e.touches[0].clientY - currentY;
                handle.style.transition = 'none'; 
            });

            handle.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                let y = e.touches[0].clientY - startY;
                y = Math.max(0, Math.min(y, maxDrag));
                currentY = y;
                handle.style.transform = `translateX(-50%) translateY(${y}px)`;
                
                let tension = y / maxDrag; 
                document.documentElement.style.setProperty('--tension-level', tension);
                
                if (tension > 0.1) {
                    if(navigator.vibrate && Math.random() > (1 - tension)) navigator.vibrate(10);
                    let shake = tension * 2;
                    container.style.transform = `translate(${Math.random()*shake - shake/2}px, ${Math.random()*shake - shake/2}px)`;
                }

                if(tension > 0.8) {
                    handle.classList.add('surging');
                    els.instruction.innerText = "!!! CRITICAL RELEASE !!!";
                } else {
                    handle.classList.remove('surging');
                }
            });

            handle.addEventListener('touchend', () => {
                isDragging = false;
                if (currentY > maxDrag * 0.95) {
                    handle.style.transform = `translateX(-50%) translateY(${maxDrag}px)`;
                    document.documentElement.style.setProperty('--tension-level', 1);
                    triggerFinale();
                } else {
                    currentY = 0;
                    handle.style.transition = 'transform 0.3s cubic-bezier(0.5, 0, 0.2, 1)';
                    handle.style.transform = `translateX(-50%) translateY(0px)`;
                    document.documentElement.style.setProperty('--tension-level', 0);
                    handle.classList.remove('surging');
                    container.style.transform = 'none';
                    els.instruction.innerText = "DRAG THE HANDLE DOWN TO FIRE";
                }
            });
        }

        function triggerFinale() {
            if(navigator.vibrate) navigator.vibrate([2000]); 
            els.dialogLayer.style.display = 'none';
            els.instruction.innerText = "DISCHARGING...";
            els.lightBloom.classList.add('bloom-active');
            setTimeout(() => { els.content.classList.add('content-overexposed'); }, 500);
            setTimeout(() => { els.whiteout.classList.add('whiteout-fade-in'); }, 1000);
            setTimeout(() => { sendCompletionMessage(); }, 3000);
        }

        async function sendCompletionMessage() {
            try {
                if (liff.isLoggedIn()) {
                    await liff.sendMessages([{
                        type: 'text',
                        text: "„ÄêÁ≥ªÁµ±ÊèêÁ§∫„ÄëÊôÇÁ©∫Èå®Èªû‰øÆÊ≠£ÂÆåÁï¢„ÄÇÁáàÂ°îÂÖâÊùüÂ∑≤ÁôºÂ∞Ñ„ÄÇ\n(Mission Complete)"
                    }]);
                }
            } catch (err) { console.error(err); } 
            finally { liff.closeWindow(); }
        }

        window.onload = init;
    </script>
</body>
</html>
