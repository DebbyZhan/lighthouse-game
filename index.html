<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¹¾å¦ãƒ»ç ´æ›‰ä¹‹å…‰ | CYBERPUNK VER.</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* ====================
           CYBERPUNK CSS THEME CORE
           ==================== */
        :root {
            /* æ“´å……è‰²æ¿ */
            --primary-color: #0f0;   /* Neon Green (æ•¸æ“š) */
            --secondary-color: #0ff; /* Cyber Cyan (UIé‚Šæ¡†) */
            --accent-color: #f0f;    /* Magenta (è­¦å‘Š/å¼·èª¿) */
            --bg-color: #020205;     /* æ·±ç©ºé»‘è— */
            --bg-dark: rgba(0, 5, 10, 0.9);
            
            /* å­—é«”çµ„åˆ */
            --mono-font: 'VT323', 'Courier New', monospace; /* å¾©å¤åƒç´ æ„Ÿ */
            --tech-font: 'Orbitron', sans-serif; /* æœªä¾†æ„Ÿæ¨™é¡Œ */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); 
            color: var(--primary-color);
            font-family: var(--mono-font); font-size: 18px;
            overflow: hidden; touch-action: none; user-select: none;
            overscroll-behavior: none;
            /* åŠ å…¥å¾®å¦™çš„èƒŒæ™¯æ•¸ä½ç¶²æ ¼ */
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- V9 æ ¸å¿ƒç‰¹æ•ˆï¼šCRT æƒæç·šè¦†è“‹å±¤ --- */
        body::after {
            content: " ";
            display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 9990; pointer-events: none; background-size: 100% 2px, 3px 100%;
        }
        /* è¢å¹•å››å‘¨æšˆå½± */
        body::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: radial-gradient(circle, transparent 60%, rgba(0,0,0,0.8) 100%);
            z-index: 9991; pointer-events: none;
        }

        /* é€šç”¨éœ“è™¹æ–‡å­—ç‰¹æ•ˆ */
        h1, h2, .glow-text {
            font-family: var(--tech-font);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 5px var(--secondary-color), 0 0 15px var(--primary-color);
        }

        /* ====================
           UI çµ„ä»¶
           ==================== */
        
        /* è¼‰å…¥å±¤ - åŠ å…¥ Glitch æ•ˆæœ */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
        }
        .loading-text { 
            font-size: 1.5rem; 
            animation: glitch-pulse 1s infinite alternate;
            position: relative;
        }
        /* ç°¡å–®çš„æ–‡å­—æ•…éšœå‹•ç•« */
        @keyframes glitch-pulse {
            0% { text-shadow: 2px 0 0 var(--accent-color), -2px 0 0 var(--secondary-color); opacity: 1;}
            20% { text-shadow: 2px 0 0 var(--accent-color), -2px 0 0 var(--secondary-color); opacity: 0.8;}
            50% { text-shadow: -2px 0 0 var(--accent-color), 2px 0 0 var(--secondary-color); opacity: 1; transform: skewX(-2deg);}
            100% { text-shadow: 2px 0 0 var(--accent-color), -2px 0 0 var(--secondary-color); opacity: 1;}
        }

        /* Cyberpunk æŒ‰éˆ• */
        #start-btn {
            margin-top: 30px; padding: 15px 40px;
            font-family: var(--tech-font); font-size: 1.2rem; letter-spacing: 2px;
            color: var(--secondary-color);
            background: transparent;
            border: 2px solid var(--secondary-color);
            /* è£½ä½œåˆ‡è§’æ•ˆæœ */
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3), inset 0 0 15px rgba(0, 255, 255, 0.1);
            cursor: pointer; transition: all 0.3s;
            position: relative; overflow: hidden;
        }
        #start-btn::before { /* æŒ‰éˆ•æƒå…‰ç‰¹æ•ˆ */
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.4), transparent);
            transition: 0.5s;
        }
        #start-btn:hover::before { left: 100%; }
        #start-btn:active { background: var(--secondary-color); color: #000; box-shadow: 0 0 30px var(--secondary-color); }

        /* å…§å®¹å±¤èˆ‡è®Šæš— */
        #content-layer { width: 100%; height: 100%; transition: filter 0.5s ease; will-change: filter; }
        .content-dimmed { filter: brightness(0.2) blur(3px) grayscale(50%); }

        .stage-box {
            width: 100%; height: 100%; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            text-align: center; padding-top: 30px;
        }

        .gps-status { font-size: 1rem; margin-top: 15px; color: var(--accent-color); min-height: 1.2em; text-shadow: 0 0 5px var(--accent-color); }
        
        /* GPS é‡è©¦æŒ‰éˆ•æ¨£å¼ */
        #gps-retry-btn {
            margin-top: 20px; padding: 8px 20px;
            border: 1px solid var(--accent-color); background: rgba(255, 0, 255, 0.1);
            color: var(--accent-color); font-family: var(--mono-font); cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
        }

        /* ====================
           å°è©±æ¡†ç³»çµ± (HUD é¢¨æ ¼)
           ==================== */
        #dialog-layer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9995; /* åœ¨æƒæç·šä¹‹ä¸Š */
            display: flex; flex-direction: column; justify-content: flex-end;
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        #dialog-box {
            position: relative; width: 94%; margin: 0 auto 20px auto;
            background: linear-gradient(180deg, rgba(0, 20, 30, 0.95) 0%, rgba(0, 10, 15, 0.98) 100%);
            /* é›™è‰²é‚Šæ¡† */
            border: 2px solid var(--secondary-color);
            border-bottom: 4px solid var(--primary-color);
            padding: 25px 20px 20px 20px; text-align: left;
            pointer-events: auto;
            /* å¼·çƒˆå…‰æšˆ */
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.8);
            cursor: pointer;
        }
        /* è£é£¾æ€§çš„è³‡æ–™ç·šæ¢ */
        #dialog-box::before {
            content: 'DATA_STREAM // INCOMING_TRANSMISSION';
            position: absolute; top: -12px; left: 10px;
            font-size: 0.7rem; color: var(--secondary-color); background: var(--bg-color);
            padding: 2px 10px; border: 1px solid var(--secondary-color);
            letter-spacing: 1px;
        }

        .speaker { 
            font-family: var(--tech-font); font-size: 0.9rem; letter-spacing: 1px;
            font-weight: bold; margin-bottom: 10px; color: #000; 
            background: var(--secondary-color); /* é è¨­æ”¹ç‚ºè—è‰² */
            display: inline-block; padding: 4px 10px; 
            box-shadow: 0 0 10px var(--secondary-color);
            transform: skewX(-10deg); /*ç¨å¾®å‚¾æ–œ */
        }
        .dialog-text { 
            font-size: 1.2rem; line-height: 1.4; color: #e0ffe0; min-height: 3.6rem; 
            white-space: pre-wrap; 
            text-shadow: 0 0 2px rgba(0, 255, 0, 0.5);
        }
        
        .cursor { display: inline-block; width: 12px; height: 1.3rem; background: var(--primary-color); animation: blink 0.8s infinite; vertical-align: middle; margin-left: 4px; box-shadow: 0 0 5px var(--primary-color);}

        .next-arrow {
            position: absolute; bottom: 10px; right: 15px;
            color: var(--secondary-color); font-size: 1.5rem;
            animation: bounce 1s infinite; text-shadow: 0 0 10px var(--secondary-color);
        }

        /* ====================
           åˆ®åˆ®æ¨‚èˆ‡è½‰å ´
           ==================== */
        .scratch-container {
            position: relative;
            width: 90vw; height: 60vw; max-width: 600px; max-height: 400px;
            margin: 20px auto;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4), inset 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden; background-color: #000; transition: opacity 1s;
        }
        #scratch-progress {
            font-family: var(--tech-font); color: var(--secondary-color); letter-spacing: 1px;
            text-shadow: 0 0 5px var(--secondary-color);
        }

        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* è½‰å ´æ”¹ç‚ºå¼·çƒˆçš„é’ç™½å…‰ */
            background: rgb(200, 255, 255); 
            opacity: 0; pointer-events: none; z-index: 9999;
            mix-blend-mode: hard-light; /* è®“é–ƒå…‰æ›´å¼·çƒˆ */
        }
        .flash-active { animation: flashPlateau 4s forwards; }
        
        .hidden { display: none !important; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }
        @keyframes flashPlateau { 0% { opacity: 0; } 20% { opacity: 1; } 60% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-text glow-text">SYSTEM BOOT SEQUENCE</div>
        <div style="width: 200px; height: 4px; background: #333; margin: 20px 0; position: relative; overflow: hidden;">
            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 50%; background: var(--primary-color); box-shadow: 0 0 10px var(--primary-color); animation: loadBar 2s infinite ease-in-out;"></div>
        </div>
        <div class="loading-text" style="font-size: 0.9rem; color: var(--secondary-color);" id="status-log">CONNECTING TO NEURAL NET...</div>
        <button id="start-btn" class="hidden">INITIALIZE LINK</button>
    </div>

    <div id="flash-overlay"></div>

    <div id="content-layer">
        <div id="game-container" class="hidden">
            
            <div id="stage-1" class="stage-box">
                <h2 id="stage-title">å»ºç«‹æ™‚ç©ºéŒ¨é»...</h2>
                
                <div id="gps-area">
                    <div style="font-size: 3rem; color: var(--secondary-color); margin-bottom: 20px;">ğŸ›°ï¸</div>
                    <div id="gps-msg" class="gps-status">AWAITING SATELLITE LOCK...</div>
                    <button id="gps-retry-btn" class="hidden">é‡æ–°æƒæè¨Šè™Ÿ</button>
                </div>

                <div id="scratch-area" class="hidden" style="opacity: 0;">
                    <div class="scratch-container">
                        <img id="img-base" class="scratch-bg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; filter: sepia(1) hue-rotate(180deg) contrast(1.2);" /> <canvas id="cvs-cover" class="scratch-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; touch-action: none;"></canvas>
                    </div>
                    <p id="scratch-progress">SYNC RATE: 0%</p>
                </div>
            </div>

            <div id="stage-2" class="stage-box hidden">
                <h1 style="margin-top: 50%; font-size: 3rem;">STAGE 02</h1>
                <p class="glow-text" style="color: var(--secondary-color);">å…‰è­œè½‰ç›¤æ ¡æº–ä¸­...</p>
            </div>

        </div>
    </div>

    <div id="dialog-layer" class="hidden">
        <div id="dialog-box">
            <div id="speaker-name" class="speaker">SYSTEM</div>
            <div id="dialog-text-container" class="dialog-text"></div>
            <div id="next-arrow" class="next-arrow hidden">â–¼</div>
        </div>
    </div>

    <script>
        /* ====================
           Javascript é‚è¼¯ä¿æŒä¸è®Š
           ==================== */
        const CONFIG = {
            liffId: "2008882930-UEAr0VU4", 
            devMode: true,                 
            target: { lat: 22.615556, lng: 120.265833 }, 
            radius: 150,                   
            scratchThreshold: 65           
        };

        const SCRIPTS = {
            intro: [
                { name: "é˜¿æ°´ (é›œè¨Š)", text: "ï¼ˆæ»‹...æ»‹...ï¼‰è¨Šè™Ÿ...è¢«å¹²æ“¾äº†ï¼æ™‚ç©ºäº‚æµæŒ‡æ•¸é£†å‡ä¸­ï¼" },
                { name: "é˜¿æ°´ (é›œè¨Š)", text: "ç³»çµ±åµæ¸¬åˆ°ä½ é™„è¿‘æœ‰å¼·å‘é‡åæ‡‰... ä½ ç¾åœ¨äººåœ¨ç‡ˆå¡”ç†±é»å—ï¼Ÿ" },
                { name: "ç³»çµ±AI", text: "å•Ÿå‹•ç¾åœ°èªè­‰å”è­°ã€‚æ­£åœ¨æƒæ GPS é »æ®µ..." }
            ],
            gpsSuccess: [
                { name: "ç³»çµ±AI", text: "ä½ç½®ç¢ºèªï¼šæ——å¾Œå±±é ‚ç¯€é»ã€‚åµæ¸¬åˆ°é«˜å¯†åº¦æ™‚ç©ºé®è”½åŠ›å ´ã€‚" },
                { name: "ç³»çµ±AI", text: "æ­£åœ¨æ›è¼‰å½±åƒè§£ç¢¼æ¨¡çµ„..." }
            ],
            scratchIntro: [
                { name: "é˜¿æ°´", text: "é€£ä¸Šäº†ï¼...ä½†æˆ‘é€™è£¡çš„ç•«é¢å……æ»¿é›œè¨Š... é€™ç™½è‰²çš„çµæ§‹é«”... ä¸æ˜¯æˆ‘è¨˜æ†¶ä¸­çš„æ¨£å­ï¼" },
                { name: "ç²½å“¥ (é€šè¨Š)", text: "å…©å€‹æ™‚é–“ç·šçš„æ•¸æ“šæ­£åœ¨è¡çªã€‚æ“ä½œå“¡ï¼Œç”¨ä½ çš„ç”Ÿç‰©é›»å ´ï¼ˆæ‰‹æŒ‡ï¼‰åˆ®é–‹ç¾ä»£çš„å½è£åœ–å±¤ï¼" },
                { name: "ç³»çµ±AI", text: "è«‹é–‹å§‹åŒæ­¥è¦–è¦ºæ•¸æ“šã€‚" }
            ],
            stage1Clear: [
                { name: "é˜¿æ°´", text: "é›œè¨Šæ¸…é™¤äº†ï¼ç´…è‰²çš„ç£šç‰†... æ²’éŒ¯ï¼Œé€™å°±æ˜¯æˆ‘é€™å€‹åº§æ¨™çš„ç‡ˆå¡”ï¼" },
                { name: "é˜¿æ°´", text: "éŒ¨é»åŒæ­¥å®Œæˆï¼é€™ä¸‹è¨Šè™Ÿç©©å®šäº†ï¼" },
                { name: "ç³»çµ±AI", text: "STAGE 1 å®Œæˆã€‚æ­£åœ¨åˆå§‹åŒ–å…‰è­œè½‰ç›¤ä»‹é¢..." }
            ]
        };

        const ASSETS = { images: { modern: null, old: null } };
        function loadImages() { return new Promise(resolve => { resolve(); }); }
        function createImg(src) { if(!src) return null; const img = new Image(); img.crossOrigin = "Anonymous"; img.src = src; return img; }

        const els = {
            log: document.getElementById('status-log'),
            startBtn: document.getElementById('start-btn'),
            content: document.getElementById('content-layer'),
            dialogLayer: document.getElementById('dialog-layer'),
            dialogBox: document.getElementById('dialog-box'),
            speaker: document.getElementById('speaker-name'),
            text: document.getElementById('dialog-text-container'),
            arrow: document.getElementById('next-arrow'),
            game: document.getElementById('game-container'),
            loading: document.getElementById('loading-screen'),
            flash: document.getElementById('flash-overlay')
        };

        function log(msg) { els.log.innerText = msg; console.log(`[Sys] ${msg}`); }

        let scriptQueue = [];
        let onScriptComplete = null;
        let typingTimer = null;
        let currentFullText = "";
        let isTyping = false;

        function playScript(script, callback) {
            scriptQueue = [...script]; 
            onScriptComplete = callback;
            els.dialogLayer.classList.remove('hidden');
            els.content.classList.add('content-dimmed');
            nextDialog();
        }

        function nextDialog() {
            if (scriptQueue.length === 0) {
                els.dialogLayer.classList.add('hidden');
                els.content.classList.remove('content-dimmed');
                if (onScriptComplete) onScriptComplete();
                return;
            }

            const line = scriptQueue.shift();
            els.speaker.innerText = line.name;
            currentFullText = line.text;

            // æ›´æ–°è§’è‰²çš„ Cyberpunk é…è‰²
            if (line.name.includes("é˜¿æ°´")) {
                els.speaker.style.backgroundColor = "var(--primary-color)"; // ç¶ è‰²
                els.speaker.style.color = "#000";
                els.speaker.style.boxShadow = "0 0 10px var(--primary-color)";
            } else if (line.name.includes("ç²½å“¥")) {
                els.speaker.style.backgroundColor = "#555"; 
                els.speaker.style.color = "#fff";
                els.speaker.style.boxShadow = "none";
            } else { // ç³»çµ± AI
                els.speaker.style.backgroundColor = "var(--secondary-color)"; // è—è‰²
                els.speaker.style.color = "#000";
                els.speaker.style.boxShadow = "0 0 10px var(--secondary-color)";
            }

            startTyping(currentFullText);
        }

        function startTyping(text) {
            isTyping = true;
            els.text.innerHTML = "";
            els.arrow.classList.add('hidden');
            let i = 0;
            const cursor = '<span class="cursor"></span>';
            
            clearInterval(typingTimer);
            typingTimer = setInterval(() => {
                els.text.innerHTML = text.substring(0, i+1) + cursor;
                i++;
                if (i >= text.length) finishTyping();
            }, 35); 
        }

        function finishTyping() {
            clearInterval(typingTimer);
            isTyping = false;
            els.text.innerText = currentFullText;
            els.arrow.classList.remove('hidden');
        }

        els.dialogBox.addEventListener('click', () => {
            if (isTyping) finishTyping();
            else {
                if (navigator.vibrate) navigator.vibrate(10);
                nextDialog();
            }
        });

        async function initSystem() {
            try {
                log("INIT LIFF CORE...");
                await liff.init({ liffId: CONFIG.liffId });
                await loadImages();
                
                log("SYSTEM READY.");
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                els.startBtn.classList.remove('hidden');
            } catch (err) { 
                log("ERROR: " + err.message); 
                if(CONFIG.devMode) els.startBtn.classList.remove('hidden');
            }
        }

        els.startBtn.addEventListener('click', () => {
            els.loading.classList.add('hidden');
            els.game.classList.remove('hidden');
            playScript(SCRIPTS.intro, checkGPS);
        });

        function checkGPS() {
            const msgBox = document.getElementById('gps-msg');
            const retryBtn = document.getElementById('gps-retry-btn');
            
            msgBox.innerText = "SCANNING COORDINATES...";
            msgBox.style.color = "var(--secondary-color)";
            retryBtn.classList.add('hidden');

            if (!navigator.geolocation) { msgBox.innerText = "GPS MODULE NOT FOUND"; msgBox.style.color = "var(--accent-color)"; return; }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const dist = getDistanceFromLatLonInKm(lat, lng, CONFIG.target.lat, CONFIG.target.lng) * 1000;

                    if (CONFIG.devMode || dist < CONFIG.radius) {
                        msgBox.innerText = `ğŸ“ NODE ACQUIRED: æ——å¾Œå±± (${dist.toFixed(0)}m)`;
                        msgBox.style.color = "var(--primary-color)";
                        msgBox.style.textShadow = "0 0 10px var(--primary-color)";
                        setTimeout(() => playScript(SCRIPTS.gpsSuccess, initScratchGame), 1000);
                    } else {
                        msgBox.innerText = `âš ï¸ SIGNAL WEAK: TARGET DELTA ${(dist).toFixed(0)}m`;
                        msgBox.style.color = "var(--accent-color)";
                        msgBox.style.textShadow = "0 0 10px var(--accent-color)";
                        retryBtn.classList.remove('hidden');
                        retryBtn.onclick = checkGPS;
                    }
                },
                (err) => {
                    msgBox.innerText = "LOCATION DATA ACCESS DENIED";
                    msgBox.style.color = "var(--accent-color)";
                    retryBtn.classList.remove('hidden');
                    retryBtn.onclick = checkGPS;
                }, { enableHighAccuracy: true, timeout: 5000 }
            );
        }

        function initScratchGame() {
            const scratchArea = document.getElementById('scratch-area');
            scratchArea.classList.remove('hidden');
            setTimeout(() => scratchArea.style.opacity = 1, 100);
            
            document.getElementById('gps-area').classList.add('hidden');
            document.getElementById('stage-title').innerText = "åŒæ­¥æ™‚ç©ºè¦–é‡";

            playScript(SCRIPTS.scratchIntro, setupCanvas);
        }

        function setupCanvas() {
            const canvas = document.getElementById('cvs-cover');
            const ctx = canvas.getContext('2d');
            const imgBase = document.getElementById('img-base');
            const container = canvas.parentElement;

            if (ASSETS.images.old) imgBase.src = ASSETS.images.old.src;

            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr); 

            const drawLayer = () => {
                ctx.globalCompositeOperation = 'source-over';
                if (ASSETS.images.modern && ASSETS.images.modern.complete) {
                    ctx.drawImage(ASSETS.images.modern, 0, 0, rect.width, rect.height);
                } else {
                    // Cyberpunk é¢¨æ ¼çš„é è¨­é®ç½©
                    ctx.fillStyle = '#0a0a0a'; 
                    ctx.fillRect(0, 0, rect.width, rect.height);
                    // ç¹ªè£½ä¸€äº›ç§‘å¹»ç¶²æ ¼
                    ctx.strokeStyle = 'rgba(0, 255, 255, 0.2)';
                    ctx.lineWidth = 1;
                    for(let i=0; i<rect.width; i+=30) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,rect.height); ctx.stroke(); }
                    for(let i=0; i<rect.height; i+=30) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(rect.width,i); ctx.stroke(); }
                    
                    ctx.fillStyle = 'var(--secondary-color)';
                    ctx.font = "bold 24px Orbitron";
                    ctx.fillText("NO SIGNAL // MASK LAYER", 30, rect.height/2);
                }
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 40; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            };

            if (ASSETS.images.modern && !ASSETS.images.modern.complete) {
                ASSETS.images.modern.onload = drawLayer;
            } else { drawLayer(); }

            let isDrawing = false;
            const getPos = (e) => {
                const touch = e.touches[0];
                const r = canvas.getBoundingClientRect();
                return { x: touch.clientX - r.left, y: touch.clientY - r.top };
            };

            canvas.addEventListener('touchstart', (e) => { 
                isDrawing = true; e.preventDefault();
                const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                if (!isDrawing) return; e.preventDefault();
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y); ctx.stroke();
                ctx.beginPath(); ctx.arc(pos.x, pos.y, 20, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
            }, { passive: false });

            canvas.addEventListener('touchend', () => {
                isDrawing = false; checkProgress(ctx, canvas.width, canvas.height);
            });
        }

        let stage1Finished = false;
        function checkProgress(ctx, w, h) {
            if (stage1Finished) return; 
            const data = ctx.getImageData(0, 0, w, h).data;
            let transparent = 0; const sampleRate = 32;
            for(let i = 3; i < data.length; i += 4 * sampleRate) { if(data[i] < 128) transparent++; }
            const totalSamples = data.length / (4 * sampleRate);
            const percent = Math.floor((transparent / totalSamples) * 100);
            
            document.getElementById('scratch-progress').innerText = `SYNC RATE: ${percent}%`;
            
            if (percent > CONFIG.scratchThreshold) {
                stage1Finished = true;
                finishStage1();
            }
        }

        function finishStage1() {
            if (navigator.vibrate) navigator.vibrate([50, 30, 50, 30, 200]); // æ›´å¼·çƒˆçš„éœ‡å‹•
            setTimeout(() => {
                els.flash.classList.add('flash-active');
                setTimeout(() => {
                    document.getElementById('stage-1').classList.add('hidden');
                    document.getElementById('stage-2').classList.remove('hidden');
                    setTimeout(() => {
                        playScript(SCRIPTS.stage1Clear, () => { console.log("Stage 2 Start"); });
                    }, 2000); 
                }, 1500); 
            }, 1000); 
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
            var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            var c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R*c;
        }
        function deg2rad(deg) { return deg*(Math.PI/180); }

        window.onload = initSystem;
        
        // åŠ å…¥è®€å–æ¢å‹•ç•«
        const style = document.createElement('style');
        style.innerHTML = `@keyframes loadBar { 0% { left: -50%; } 100% { left: 100%; } }`;
        document.head.appendChild(style);
    </script>
</body>
</html>
